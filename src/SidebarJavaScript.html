<script>
  //Consts
  const ExportSheetTypes = {
    All: "allSheets",
    CurrentOnly: "currentSheet",
    Custom: "custom"
  };
  const ExportFormats = {
    JSON: "jsonFormat",
    XML: "xmlFormat"
  };
  /**
   * MIME types for exported data files and picker operations.
   * @enum {string}
   **/
  const MimeTypes = {
    Folder: "application/vnd.google-apps.folder",
    JSON: "application/json",
    XML: "application/xml",
    Text: "text/plain"
  };
  //General
  const IGNORE_COLUMN_DEFAULT = "NOEX_";
  const UNWRAP_SHEETS_DEFAULT = "US_";
  const COLLAPSE_SHEETS_DEFAULT = "CS_";
  const EXPORT_FOLDER_LOCATIONS = {
    MyDrive: "MyDrive",
    Custom: "Custom"
  };
  const REPLACE_FILE_OPTIONS = {
    Enabled: "Enabled",
    Disabled: "Disabled"
  };
  const SELECT_FILE_KEYS = {
    File: "file",
    Valid: "valid"
  };
  //XML
  const XML_ROOT_DEFAULT = "data";
  const XML_ATT_DEFAULT = "ATT_";
  const XML_CE_DEFAULT = "CE_";
  const XML_IT_DEFAULT = "IT_";
  const XML_DECLARATION_ENCODINGS = [
    "None",
    "UTF-8",
    "UTF-16",
    "ISO-10646-UCS-2",
    "ISO-10646-UCS-4",
    "ISO-8859-1",
    "ISO-8859-2",
    "ISO-8859-3",
    "ISO-8859-4",
    "ISO-8859-5",
    "ISO-8859-6",
    "ISO-8859-7",
    "ISO-8859-8",
    "ISO-8859-9",
    "ISO-2022-JP",
    "Shift_JIS",
    "EUC-JP"
  ];
  //Namespaces
  const XML_NAMESPACE_PLACEHOLDER = "No XML namespaces set. Click the [+] button to add a namespace.";
  //JSON
  const JSON_SEPARATOR_DEFAULT = ","; //TODO: Cannot be " or ' chars
  const JSON_JA_DEFAULT = "JA_";
  //Nesting Elements
  const NEST_NA_DEFAULT = "NA_";

  //Keys
  const Keys = {
    Content: {
      Format: "exportType",
      Visualize: "visualize",
      SingleSheet: "singleSheet",
      Sheets: "exportSheets",
      TargetSheets: "targetSheets"
    },
    Export: {
      Folder: "exportFolderId",
      FolderType: "exportFolderType",
      JSON: {
        ReplaceFile: "replaceFileId",
        ReplaceFileType: "replaceFileType"
      },
      XML: {
        ReplaceFile: "replaceFileId",
        ReplaceFileType: "replaceFileType"
      }
    },
    General: {
      Minify: "minifyData",
      BoolsAsInts: "exportBoolsAsInts",
      IgnoreEmpty: "ignoreEmptyCells",
      IncludeFirstColumn: "includeFirstColumn",
      Advanced: {
        UnwrapSingle: "unwrapSingleRows",
        CollapseSingle: "collapseSingleRows",
        NestedElements: "nestedElements",
        IgnoreWithPrefix: "ignoreColumnsWithPrefix",
        IgnorePrefix: "ignorePrefix",
        UnwrapWithPrefix: "unwrapSheetsWithPrefix",
        UnwrapPrefix: "unwrapPrefix",
        CollapseWithPrefix: "collapseSheetsWithPrefix",
        CollapsePrefix: "collapsePrefix"
      }
    },
    JSON: {
      CellArray: "exportCellArray",
      SheetArray: "exportSheetArray",
      ValueArray: "exportValueArray",
      ForceString: "forceString",
      Advanced: {
        ContentsAsArray: "exportContentsAsArray",
        CellObject: "exportCellObject",
        EmptyValueFormat: "emptyValueFormat",
        NullValueFormat: "nullValueFormat",
        SeparatorChar: "separatorChar",
        ForceArray: "forceArray",
        ForceArrayPrefix: "forceArrayPrefix",
        ForceNestedArray: "forceArrayNest",
        ForceNestedArrayPrefix: "forceArrayNestPrefix"
      }
    },
    XML: {
      ChildElements: "exportChildElements",
      RootElement: "rootElement",
      Advanced: {
        NameReplacementChar: "nameReplacementChar",
        IncludeDeclaration: "includeDeclaration",
        DeclarationVersion: "declarationVersion",
        DeclarationEncoding: "declarationEncoding",
        DeclarationStandalone: "declarationStandalone",
        ForceAttributes: "forceAttributes",
        ForceAttributesPrefix: "attributePrefix",
        ForceChildElements: "forceChildElements",
        ForceChildElementsPrefix: "childElementPrefix",
        ForceInnerText: "forceInnerText",
        ForceInnerTextPrefix: "innerTextPrefix",
        RootNamespace: "rootNamespace",
        Namespaces: "namespaces"
      }
    },
    Objects: {
      Export: "export",
      JSON: "json",
      XML: "xml",
      Advanced: "advanced"
    }
  };
  
  //Visualization
  let visualizeData = false;
  
  //Format options
  //The format to export data as
  let exportFormatType = ExportFormats.JSON;
  //Determines what sheets to export data from
  let exportSheetsType = "allSheets";
  //Specific sheets to export data from
  /*
  {
    "0": true
  }
  */
  let targetSheets = {};
  //Array of sheets in the current spreadsheet
  /*
  [
    {
      name: "sheetName",
      id: 0,
      toggleName: "sheetName",
      toggleId: "0"
    }
  ]
  */
  let currentSheets = [];
  //Determines the export location
  let exportFolderType = EXPORT_FOLDER_LOCATIONS.MyDrive;
  //The folder to export files to
  let exportFolderId = "";
  
  //General Options
  //Export data without spaces or newlines
  let minifyData = false;
  //Export boolean values as "1" or "0" instead of "true" or "false" respectively.
  let exportBoolsAsInts = false;
  //Don't export cells that are empty (helps reduce file size)
  let ignoreEmptyCells = false;
  //Include the first column in the export in addition to using it as the name for the row element.
  let includeFirstColumn = false;
  //Don't wrap the contents of a sheet in a JSON object / XML element if the sheet only has one row
  let unwrapSingleRows = false;
  //Collapse the contents of a sheet in a JSON object / XML element if the sheet only has one row
  let collapseSingleRows = false;
  
  //Advanced Options
  //Support complex nested elements by using special key formatting
  let nestedElements = false;
  //Don't export columns with the ignore prefix
  let ignoreColumnsWithPrefix = false;
  let ignoreColumnsPrefix = "NOEX_";
  //Unwrap sheets with this prefix
  let unwrapSheetsWithPrefix = false;
  let unwrapSheetsPrefix = "US_";
  //Collapse sheets with one row and this prefix
  let collapseSheetsWithPrefix = false;
  let collapseSheetsPrefix = "CS_";
  
  //XML Options
  //Determines file update behaviour
  let replaceFileXmlType = REPLACE_FILE_OPTIONS.Disabled;
  //Replace contents of file specified
  let replaceFileXmlId = "";
  let replaceFileXmlName = "";
  //Export values as child elements instead of attributes
  let exportChildElementXml = false;
  //Root element of the XML document
  let rootElementXml = "data";
  
  //XML Advanced Options
  //XML element name invalid char replacement
  let nameReplacementCharXml = "_";
  //XML declaration inclusion
  let includeDeclarationXml = false;
  //XML declaration version
  let declarationVersionXml = "1.0";
  //XML declaration encoding
  let declarationEncodingXml = "none";
  //XML declaration standalone
  let declarationStandaloneXml = "none";
  //Columns using keys starting with a specified string will always be exported as attributes
  let forceAttributesXml = false;
  let forceAttributesPrefixXml = "ATT_";
  //Columns using keys starting with a specified string will always be exported as child elements
  let forceChildElementsXml = false;
  let forceChildElementsPrefixXml = "CE_";
  //Columns using keys starting with a specified string will always be exported as inner text
  let forceInnerTextXml = false;
  let forceInnerTextPrefixXml = "IT_";
  //Namespaces
  let rootNamespace = "";
  let namespaces = []; //Array of JSON objects with prefix and uri fields.
  
  //JSON Options
  //Determines file update behaviour
  let replaceFileJsonType = REPLACE_FILE_OPTIONS.Disabled;
  //Replace contents of file specified
  let replaceFileJsonId = "";
  let replaceFileJsonName = "";
  //Export cell contents as a JSON array if the cell contains commas
  let exportCellArrayJson = false;
  //Export a sheet's contents as an array, with each row being one JSON object element in the array
  let exportSheetArrayJson = false;
  //Export a sheet's contents as an array of values if the sheet contains only one column
  let exportValueArrayJson = false;
  //Force every value to be a string instead of the default bool/int/float/etc.
  let forceStringJson = false;
  
  //JSON Advanced Options
  //Export the spreadsheet's contents as a JSON array, instead of a regular JSON object
  let exportContentsAsArrayJson = false;
  //Export cell contents as a JSON object if the cell is wrapped with {}
  let exportCellObjectJson = false;
  //Export sheets as 2D JSON arrays
  let export2dArrayJson = false;
  //Value to export empty cells as, null (null) or empty string ("")
  let emptyValueFormatJson = "null";
  //Value to export null strings as, null (null) or string ("null")
  let nullValueFormatJson = "null";
  //Separator char for JSON arrays
  let arraySeparatorCharJson = ",";
  //Sheets or columns using keys starting with a specified string will always be exported as JSON arrays
  let forceArrayJson = false;
  let forceArrayPrefixJson = "JA_";
  //Sheets using the specified prefix will always be exported as nested arrays
  let forceArrayNest = false;
  let forceArrayPrefixNest = "NAR_";
  
  /**
   * Get the properties for the sheet to automatically set values based on the user's last export for this document.
   **/
  function getProperties(onSuccess, onFailure)
  {
    return google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getExportProperties();
  }
  
  /**
   * Saves the properties for the user's last export for this document so they are automatically set the next time the document opens..
   **/
  function setProperties()
  {
    return google.script.run.withFailureHandler(onSetPropertiesFailure).setExportProperties(generateProperties());
  }
  
  /**
   * Safety check in case getting properties throws an error. This can occur due to a bug on Google's side of Apps Script execution that involves multiple accounts being signed in.
   * @param {Error} error
   **/
  function onGetPropertiesFailure(error)
  {
    //alert("There was an error retrieving user settings. This is most often due to multiple accounts being signed in. Please sign out of all but one account and reload the document.");
    google.script.run.openErrorModal("Settings Error", 
      "There was an error retrieving user settings, so default settings have been loaded. This is most often due to multiple accounts being signed in.", 
      error.stack);
    
    //Open the sidebar with default values.
    updateProperties(null);
  }
  
  /**
   * Safety check in case setting properties throws an error. This could occur due to a bug on Google's side of Apps Script execution that involves multiple accounts being signed in.
   * @param {Error} error
   **/
  function onSetPropertiesFailure(error)
  {
    //Log an error to the console.
    console.error(error.message + "\n" + error.stack);
    /*google.script.run.openErrorModal("Settings Error", 
      "There was an error updating user settings. This is most often due to multiple accounts being signed in (more info <a href='https://github.com/Synthoid/ExportSheetData#install'>here</a>).", 
      error.message + "\n" + error.stack);*/
  }
  
  /** 
   * Actually sets the local properties based on stored settings.
   * @param {?string} properties - Stringified JSON representing settings
   **/
  function updateProperties(properties)
  {
    let settings = {};
    
    if(properties != null && properties !== "")
    {
      try
      {
        settings = JSON.parse(properties);
      }
      catch(e)
      {
        settings = {};

        google.script.run.openErrorModal("Settings Error", 
          "There was an error retrieving user settings, so default settings have been loaded. This is most often due to multiple accounts being signed in or malformed settings.", 
          e.stack);
      }
    }
    
    //Content
    tryValidateValue(settings, Keys.Content.Format, (newValue) => exportFormatType = newValue);
    tryValidateValue(settings, Keys.Content.Sheets, (newValue) => {
      if(newValue !== "") exportSheetsType = newValue;
    });
    tryValidateValue(settings, Keys.Content.TargetSheets, (newValue) => { 
      if(newValue != null)
      {
        try
        {
          let sheetIds = newValue;
          targetSheets = {};

          for(let i=0; i < sheetIds.length; i++)
          {
            targetSheets[sheetIds[i].toString()] = true;
          }
        }
        catch(e)
        {
          targetSheets = {};
        }
      }
    });
    
    //General
    tryValidateValue(settings, Keys.General.Minify, (newValue) => minifyData = newValue === true);
    tryValidateValue(settings, Keys.General.BoolsAsInts, (newValue) => exportBoolsAsInts = newValue === true);
    tryValidateValue(settings, Keys.General.IgnoreEmpty, (newValue) => ignoreEmptyCells = newValue === true);
    tryValidateValue(settings, Keys.General.IncludeFirstColumn, (newValue) => includeFirstColumn = newValue === true);

    //Advanced
    tryValidateValue(settings, Keys.General.Advanced.NestedElements, (newValue) => nestedElements = newValue === true);
    tryValidateValue(settings, Keys.General.Advanced.UnwrapSingle, (newValue) => unwrapSingleRows = newValue === true);
    tryValidateValue(settings, Keys.General.Advanced.CollapseSingle, (newValue) => collapseSingleRows = newValue === true);
    tryValidateValue(settings, Keys.General.Advanced.IgnoreWithPrefix, (newValue) => ignoreColumnsWithPrefix = newValue === true);
    tryValidateValue(settings, Keys.General.Advanced.IgnorePrefix, (newValue) => ignoreColumnsPrefix = newValue === "" ? IGNORE_COLUMN_DEFAULT : newValue);
    tryValidateValue(settings, Keys.General.Advanced.UnwrapWithPrefix, (newValue) => unwrapSheetsWithPrefix = newValue === true);
    tryValidateValue(settings, Keys.General.Advanced.UnwrapPrefix, (newValue) => unwrapSheetsPrefix = newValue === "" ? UNWRAP_SHEETS_DEFAULT : newValue);
    tryValidateValue(settings, Keys.General.Advanced.CollapseWithPrefix, (newValue) => collapseSheetsWithPrefix = newValue === true);
    tryValidateValue(settings, Keys.General.Advanced.CollapsePrefix, (newValue) => collapseSheetsPrefix = newValue === "" ? COLLAPSE_SHEETS_DEFAULT : newValue);
    
    //JSON
    let jsonSettings = settings.hasOwnProperty(Keys.Objects.JSON) ? settings[Keys.Objects.JSON] : settings;

    tryValidateValue(jsonSettings, Keys.JSON.CellArray, (newValue) => exportCellArrayJson = newValue === true);
    tryValidateValue(jsonSettings, Keys.JSON.SheetArray, (newValue) => exportSheetArrayJson = newValue === true);
    tryValidateValue(jsonSettings, Keys.JSON.ValueArray, (newValue) => exportValueArrayJson = newValue === true);
    tryValidateValue(jsonSettings, Keys.JSON.ForceString, (newValue) => forceStringJson = newValue === true);

    //Advanced JSON
    let jsonAdvancedSettings = jsonSettings.hasOwnProperty(Keys.Objects.Advanced) ? jsonSettings[Keys.Objects.Advanced] : jsonSettings;

    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.ContentsAsArray, (newValue) => exportContentsAsArrayJson = newValue === true);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.CellObject, (newValue) => exportCellObjectJson = newValue === true);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.EmptyValueFormat, (newValue) => emptyValueFormatJson = newValue === "" ? emptyValueFormatJson : newValue);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.NullValueFormat, (newValue) => nullValueFormatJson = newValue === "" ? nullValueFormatJson : newValue);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.SeparatorChar, (newValue) => arraySeparatorCharJson = newValue === "" ? JSON_SEPARATOR_DEFAULT : newValue);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.ForceArray, (newValue) => forceArrayJson = newValue === true);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.ForceArrayPrefix, (newValue) => forceArrayPrefixJson = newValue === "" ? JSON_JA_DEFAULT : newValue);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.ForceNestedArray, (newValue) => forceArrayNest = newValue === true);
    tryValidateValue(jsonAdvancedSettings, Keys.JSON.Advanced.ForceNestedArrayPrefix, (newValue) => forceArrayPrefixNest = newValue === "" ? NEST_NA_DEFAULT : newValue);
    
    //XML
    let xmlSettings = settings.hasOwnProperty(Keys.Objects.XML) ? settings[Keys.Objects.XML] : settings;

    tryValidateValue(xmlSettings, Keys.XML.ChildElements, (newValue) => exportChildElementXml = newValue === true);
    tryValidateValue(xmlSettings, Keys.XML.RootElement, (newValue) => rootElementXml = newValue === "" ? rootElementXml : newValue);

    //Advanced XML
    let xmlAdvancedSettings = xmlSettings.hasOwnProperty(Keys.Objects.Advanced) ? xmlSettings[Keys.Objects.Advanced] : xmlSettings;

    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.NameReplacementChar, (newValue) => nameReplacementCharXml = newValue === "" ? nameReplacementCharXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.IncludeDeclaration, (newValue) => includeDeclarationXml = newValue === true);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.DeclarationVersion, (newValue) => declarationVersionXml = newValue === "" ? declarationVersionXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.DeclarationEncoding, (newValue) => declarationEncodingXml = newValue === "" ? declarationEncodingXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.DeclarationStandalone, (newValue) => declarationStandaloneXml = newValue === "" ? declarationStandaloneXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.ForceAttributes, (newValue) => forceAttributesXml = newValue === true);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.ForceAttributesPrefix, (newValue) => forceAttributesPrefixXml = newValue === "" ? forceAttributesPrefixXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.ForceChildElements, (newValue) => forceChildElementsXml = newValue === true);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.ForceChildElementsPrefix, (newValue) => forceChildElementsPrefixXml = newValue === "" ? forceChildElementsPrefixXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.ForceInnerText, (newValue) => forceInnerTextXml = newValue === true);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.ForceInnerTextPrefix, (newValue) => forceInnerTextPrefixXml = newValue === "" ? forceInnerTextPrefixXml : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.RootNamespace, (newValue) => rootNamespace = newValue === "" ? rootNamespace : newValue);
    tryValidateValue(xmlAdvancedSettings, Keys.XML.Advanced.Namespaces, (newValue) => namespaces = newValue);

    //Export
    let exportSettings = settings.hasOwnProperty(Keys.Objects.Export) ? settings[Keys.Objects.Export] : settings;

    tryValidateValue(exportSettings, Keys.Export.Folder, (newValue) => exportFolderId = newValue);
    tryValidateValue(exportSettings, Keys.Export.FolderType, (newValue) => exportFolderType = newValue);

    //JSON
    let exportJsonSettings = exportSettings.hasOwnProperty(Keys.Objects.JSON) ? exportSettings[Keys.Objects.JSON] : exportSettings;

    tryValidateValue(exportJsonSettings, Keys.Export.JSON.ReplaceFile, (newValue) => replaceFileJsonId = newValue);
    tryValidateValue(exportJsonSettings, Keys.Export.JSON.ReplaceFileType, (newValue) => replaceFileJsonType = newValue);

    //XML
    let exportXmlSettings = exportSettings.hasOwnProperty(Keys.Objects.XML) ? exportSettings[Keys.Objects.XML] : exportSettings;

    tryValidateValue(exportXmlSettings, Keys.Export.XML.ReplaceFile, (newValue) => replaceFileXmlId = newValue);
    tryValidateValue(exportXmlSettings, Keys.Export.XML.ReplaceFileType, (newValue) => replaceFileXmlType = newValue);
    
    //Enable export and visualize buttons
    document.getElementById("exportButton").disabled = false;
    document.getElementById("visualizeButton").disabled = false;

    refreshSideBar();
  }
  
  /**
   * Generate the JSON blob representing the document's settings.
   * @return {string}
   **/
  function generateProperties()
  {
    let properties = {};
    let exportProperties = {};
    let exportJsonProperties = {};
    let exportXmlProperties = {};
    let jsonProperties = {};
    let jsonAdvancedProperties = {};
    let xmlProperties = {};
    let xmlAdvancedProperties = {};

    //Export
    exportProperties[Keys.Export.Folder] = exportFolderId;
    exportProperties[Keys.Export.FolderType] = exportFolderType;

    exportJsonProperties[Keys.Export.JSON.ReplaceFile] = replaceFileJsonId;
    exportJsonProperties[Keys.Export.JSON.ReplaceFileType] = replaceFileJsonType;

    exportXmlProperties[Keys.Export.XML.ReplaceFile] = replaceFileXmlId;
    exportXmlProperties[Keys.Export.XML.ReplaceFileType] = replaceFileXmlType;

    exportProperties[Keys.Objects.JSON] = exportJsonProperties;
    exportProperties[Keys.Objects.XML] = exportXmlProperties;
    properties[Keys.Objects.Export] = exportProperties;

    //Format
    properties[Keys.Content.Format] = exportFormatType;
    properties[Keys.Content.Visualize] = visualizeData;
    properties[Keys.Content.Sheets] = exportSheetsType;
    properties[Keys.Content.TargetSheets] = exportSheetsType === ExportSheetTypes.All ? null : getTargetSheetsArray(targetSheets);

    //General
    properties[Keys.General.Minify] = minifyData;
    properties[Keys.General.BoolsAsInts] = exportBoolsAsInts;
    properties[Keys.General.IncludeFirstColumn] = includeFirstColumn;
    properties[Keys.General.IgnoreEmpty] = ignoreEmptyCells;

    //General Advanced
    properties[Keys.General.Advanced.NestedElements] = nestedElements;
    properties[Keys.General.Advanced.UnwrapSingle] = unwrapSingleRows;
    properties[Keys.General.Advanced.CollapseSingle] = collapseSingleRows;
    properties[Keys.General.Advanced.IgnorePrefix] = ignoreColumnsPrefix === "" ? IGNORE_COLUMN_DEFAULT : ignoreColumnsPrefix;
    properties[Keys.General.Advanced.UnwrapPrefix] = unwrapSheetsPrefix === "" ? UNWRAP_SHEETS_DEFAULT : unwrapSheetsPrefix;
    properties[Keys.General.Advanced.CollapsePrefix] = collapseSheetsPrefix === "" ? COLLAPSE_SHEETS_DEFAULT : collapseSheetsPrefix;

    //JSON
    jsonProperties[Keys.JSON.ForceString] = forceStringJson;
    jsonProperties[Keys.JSON.CellArray] = exportCellArrayJson;
    jsonProperties[Keys.JSON.SheetArray] = exportSheetArrayJson;
    jsonProperties[Keys.JSON.ValueArray] = exportValueArrayJson;

    //JSON Advanced
    jsonAdvancedProperties[Keys.JSON.Advanced.ContentsAsArray] = exportContentsAsArrayJson;
    jsonAdvancedProperties[Keys.JSON.Advanced.CellObject] = exportCellObjectJson;
    jsonAdvancedProperties[Keys.JSON.Advanced.EmptyValueFormat] = emptyValueFormatJson;
    jsonAdvancedProperties[Keys.JSON.Advanced.NullValueFormat] = nullValueFormatJson;
    jsonAdvancedProperties[Keys.JSON.Advanced.SeparatorChar] = getSeparatorCharJson();
    jsonAdvancedProperties[Keys.JSON.Advanced.ForceArray] = forceArrayJson;
    jsonAdvancedProperties[Keys.JSON.Advanced.ForceArrayPrefix] = forceArrayPrefixJson === "" ? JSON_JA_DEFAULT : forceArrayPrefixJson;
    jsonAdvancedProperties[Keys.JSON.Advanced.ForceNestedArray] = forceArrayNest;
    jsonAdvancedProperties[Keys.JSON.Advanced.ForceNestedArrayPrefix] = forceArrayPrefixNest === "" ? NEST_NA_DEFAULT : forceArrayPrefixNest;

    //XML
    xmlProperties[Keys.XML.ChildElements] = exportChildElementXml;
    xmlProperties[Keys.XML.RootElement] = getRootElement();

    //XML Advanced
    xmlAdvancedProperties[Keys.XML.Advanced.NameReplacementChar] = nameReplacementCharXml;
    xmlAdvancedProperties[Keys.XML.Advanced.IncludeDeclaration] = includeDeclarationXml;
    xmlAdvancedProperties[Keys.XML.Advanced.DeclarationVersion] = getDeclarationVersion();
    xmlAdvancedProperties[Keys.XML.Advanced.DeclarationEncoding] = getDeclarationEncoding();
    xmlAdvancedProperties[Keys.XML.Advanced.DeclarationStandalone] = getDeclarationStandalone();
    xmlAdvancedProperties[Keys.XML.Advanced.ForceAttributesPrefix] = getAttributePrefix();
    xmlAdvancedProperties[Keys.XML.Advanced.ForceChildElementsPrefix] = getChildElementPrefix();
    xmlAdvancedProperties[Keys.XML.Advanced.ForceInnerTextPrefix] = getInnerTextPrefix();
    xmlAdvancedProperties[Keys.XML.Advanced.RootNamespace] = rootNamespace;
    xmlAdvancedProperties[Keys.XML.Advanced.Namespaces] = namespaces;

    jsonProperties[Keys.Objects.Advanced] = jsonAdvancedProperties;
    properties[Keys.Objects.JSON] = jsonProperties;

    xmlProperties[Keys.Objects.Advanced] = xmlAdvancedProperties;
    properties[Keys.Objects.XML] = xmlProperties;
    
    return JSON.stringify(properties);
  }
  
  /**
   * Creates a JSON blob representing the current XML settings
   * @return {string}
   **/
  function generateXmlSettings(singleSheet, sheetsToExport)
  {
    let settings = {};
    let exportSettings = {};
    let exportXmlSettings = {};
    let xmlSettings = {};
    let advancedXmlSettings = {};

    //Export
    exportSettings[Keys.Export.Folder] = exportFolderId;
    exportSettings[Keys.Export.FolderType] = exportFolderType;

    exportXmlSettings[Keys.Export.XML.ReplaceFile] = replaceFileXmlId;
    exportXmlSettings[Keys.Export.XML.ReplaceFileType] = replaceFileXmlType;

    exportSettings[Keys.Objects.XML] = exportXmlSettings;
    settings[Keys.Objects.Export] = exportSettings;

    //Format
    settings[Keys.Content.Format] = exportFormatType;
    settings[Keys.Content.Visualize] = visualizeData;
    settings[Keys.Content.SingleSheet] = singleSheet;
    settings[Keys.Content.Sheets] = exportSheetsType;
    settings[Keys.Content.TargetSheets] = exportSheetsType === ExportSheetTypes.All ? null : getTargetSheetsArray(sheetsToExport);

    //General
    settings[Keys.General.Minify] = minifyData;
    settings[Keys.General.BoolsAsInts] = exportBoolsAsInts;
    settings[Keys.General.IgnoreEmpty] = ignoreEmptyCells;
    settings[Keys.General.IncludeFirstColumn] = includeFirstColumn;

    //General Advanced
    settings[Keys.General.Advanced.NestedElements] = nestedElements;
    settings[Keys.General.Advanced.UnwrapSingle] = unwrapSingleRows;
    settings[Keys.General.Advanced.CollapseSingle] = collapseSingleRows;
    settings[Keys.General.Advanced.IgnorePrefix] = getIgnorePrefix();
    settings[Keys.General.Advanced.UnwrapPrefix] = getUnwrapPrefix();
    settings[Keys.General.Advanced.CollapsePrefix] = getCollapsePrefix();

    //XML
    xmlSettings[Keys.XML.ChildElements] = exportChildElementXml;
    xmlSettings[Keys.XML.RootElement] = getRootElement();

    //XML Advanced
    advancedXmlSettings[Keys.XML.Advanced.NameReplacementChar] = nameReplacementCharXml;
    advancedXmlSettings[Keys.XML.Advanced.IncludeDeclaration] = includeDeclarationXml;
    advancedXmlSettings[Keys.XML.Advanced.DeclarationVersion] = getDeclarationVersion();
    advancedXmlSettings[Keys.XML.Advanced.DeclarationEncoding] = getDeclarationEncoding();
    advancedXmlSettings[Keys.XML.Advanced.DeclarationStandalone] = getDeclarationStandalone();
    advancedXmlSettings[Keys.XML.Advanced.ForceAttributesPrefix] = getAttributePrefix();
    advancedXmlSettings[Keys.XML.Advanced.ForceChildElementsPrefix] = getChildElementPrefix();
    advancedXmlSettings[Keys.XML.Advanced.ForceInnerTextPrefix] = getInnerTextPrefix();
    advancedXmlSettings[Keys.XML.Advanced.RootNamespace] = rootNamespace;
    advancedXmlSettings[Keys.XML.Advanced.Namespaces] = namespaces;

    xmlSettings[Keys.Objects.Advanced] = advancedXmlSettings;
    settings[Keys.Objects.XML] = xmlSettings;
    
    return JSON.stringify(settings);
  }
  
  /**
   * Creates a JSON blob representing the current JSON settings
   * @return {string}
   **/
  function generateJsonSettings(singleSheet, sheetsToExport)
  {
    let settings = {};
    let exportSettings = {};
    let exportJsonSettings = {};
    let jsonSettings = {};
    let jsonAdvancedSettings = {};

    //Export
    exportSettings[Keys.Export.Folder] = exportFolderId;
    exportSettings[Keys.Export.FolderType] = exportFolderType;

    exportJsonSettings[Keys.Export.JSON.ReplaceFile] = replaceFileJsonId;
    exportJsonSettings[Keys.Export.JSON.ReplaceFileType] = replaceFileJsonType;

    exportSettings[Keys.Objects.JSON] = exportJsonSettings;
    settings[Keys.Objects.Export] = exportSettings;

    //Format
    settings[Keys.Content.Format] = exportFormatType;
    settings[Keys.Content.Visualize] = visualizeData;
    settings[Keys.Content.SingleSheet] = singleSheet;
    settings[Keys.Content.Sheets] = exportSheetsType;
    settings[Keys.Content.TargetSheets] = exportSheetsType === ExportSheetTypes.All ? null : getTargetSheetsArray(sheetsToExport);

    //General
    settings[Keys.General.Minify] = minifyData;
    settings[Keys.General.BoolsAsInts] = exportBoolsAsInts;
    settings[Keys.General.IgnoreEmpty] = ignoreEmptyCells;
    settings[Keys.General.IncludeFirstColumn] = includeFirstColumn;

    //General Advanced
    settings[Keys.General.Advanced.NestedElements] = nestedElements;
    settings[Keys.General.Advanced.UnwrapSingle] = unwrapSingleRows;
    settings[Keys.General.Advanced.CollapseSingle] = collapseSingleRows;
    settings[Keys.General.Advanced.IgnorePrefix] = getIgnorePrefix();
    settings[Keys.General.Advanced.UnwrapPrefix] = getUnwrapPrefix();
    settings[Keys.General.Advanced.CollapsePrefix] = getCollapsePrefix();

    //JSON
    jsonSettings[Keys.JSON.ForceString] = forceStringJson;
    jsonSettings[Keys.JSON.CellArray] = exportCellArrayJson;
    jsonSettings[Keys.JSON.SheetArray] = exportSheetArrayJson;
    jsonSettings[Keys.JSON.ValueArray] = exportValueArrayJson;

    //JSON Advanced
    jsonAdvancedSettings[Keys.JSON.Advanced.ContentsAsArray] = exportContentsAsArrayJson;
    jsonAdvancedSettings[Keys.JSON.Advanced.CellObject] = exportCellObjectJson;
    jsonAdvancedSettings[Keys.JSON.Advanced.EmptyValueFormat] = emptyValueFormatJson;
    jsonAdvancedSettings[Keys.JSON.Advanced.NullValueFormat] = nullValueFormatJson;
    jsonAdvancedSettings[Keys.JSON.Advanced.SeparatorChar] = getSeparatorCharJson();
    //jsonAdvancedSettings[Keys.JSON.Advanced.ForceArray] = forceArrayJson;
    jsonAdvancedSettings[Keys.JSON.Advanced.ForceArrayPrefix] = getForceArrayPrefixJson();
    //jsonAdvancedSettings[Keys.JSON.Advanced.ForceNestedArray] = forceArrayNest;
    jsonAdvancedSettings[Keys.JSON.Advanced.ForceNestedArrayPrefix] = getForceArrayPrefixNest();

    jsonSettings[Keys.Objects.Advanced] = jsonAdvancedSettings;
    settings[Keys.Objects.JSON] = jsonSettings;
    
    return JSON.stringify(settings);
  }

  /**
   * Check if the given object contains the specified key, and invoke a callback passing the target value if so.
   * @param {object} obj Object to check properties on.
   * @param {string} key Key to check for.
   * @param {function} callback Callback invoked to pass the target property value.
   * @return {bool} True if the object contained the given key, false otherwise.
   **/
  function tryValidateValue(obj, key, callback)
  {
    if(!obj.hasOwnProperty(key)) return false;

    callback(obj[key]);

    return true;
  }
  
  /**
   * Get the names of all sheets in the current document
   * @param {function} onSuccess - Callback invoked if the get sheet names operation is successful. This will pass an array of strings
   **/
  function getNames(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getSheetNames();
  }

  /**
   * Get the names and IDs of all sheets in the current document.
   * @param {function} onSuccess - Callback invoked if the get sheet names and ids operation is successful. This will pass an array of objects. Each object will contain the name and ID of a sheet.
   **/
  function getSheetNamesAndIds(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getSheetNamesAndIds();
  }
  
  /**
   * Get the name of the active sheet in the current document
   * @param {function} onSuccess - Callback invoked if the get sheet name operation is successful. This will pass a string
   **/
  function getActiveSheetName(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getActiveSheetName();
  }

  /**
   * Get the name and ID of the active sheet in the current document.
   * @param {function} onSuccess - Callback invoked if the get sheet name and ID operation is successful. This will pass an object.
   **/
  function getActiveSheetNameAndId(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getActiveSheetNameAndId();
  }
  
  /**
   * Get the name of the target file, based on its ID
   * @param {function} onSuccess - Callback invoked if the get file name operation is successful. This will pass a string
   **/
  function getFileName(id, onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getFileNameFromId(id);
  }
  
  /**
   * Sets the value of the export folder name text input to the returned folder name
   * @param {string} name - Name for the export folder
   **/
  function onGetExportFolderName(name)
  {
    //If the name returned is empty, then there was an error obtaining the folder, so clear the cached ID value since it can't be used.
    if(name === "") exportFolderId = "";

    refreshFileInputValues(exportFolderId, name, "exportFolderName", "openExportFolderButton");
  }
  
  /**
   * Sets the value of the replace XML file name text input to the returned file name
   * @param {string} name - Name for the target file
   **/
  function onGetReplaceFileXmlName(name)
  {
    //If the name returned is empty, then there was an error obtaining the file, so clear the cached ID value since it can't be used.
    if(name === "") replaceFileXmlId = "";

    refreshFileInputValues(replaceFileXmlId, name, "replaceFileXmlName", "openReplaceFileXmlButton");
  }
  
  /**
   * Sets the value of the replace JSON file name text input to the returned file name
   * @param {string} name - Name for the target file
   **/
  function onGetReplaceFileJsonName(name)
  {
    //If the name returned is empty, then there was an error obtaining the file, so clear the cached ID value since it can't be used.
    if(name === "") replaceFileJsonId = "";

    refreshFileInputValues(replaceFileJsonId, name, "replaceFileJsonName", "openReplaceFileJsonButton");
  }

  /**
   * Refresh file reference field values and states.
   * @param {string} fileId ID for the target file.
   * @param {string} fileName Name for the target file.
   * @param {string} inputFieldId ID for the input field displaying the file's name.
   * @param {string} buttonId ID for the button clicked to open the target file.
   **/
  function refreshFileInputValues(fileId, fileName, inputFieldId, buttonId)
  {
    tryGetElementById(inputFieldId, (element) => element.value = fileName);
    tryGetElementById(buttonId, (element) => element.disabled = fileId === "");
  }
  
  /**
   * Generate a unique UUID. Based on the solution found here: https://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid
   * @return {string}
   **/
  function getUUID()
  {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c)
    {
      let r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  
  /**
   * Converts a string into a hash.
   * @param {string} string - String to convert
   * @return {number}
   **/
  function stringToHash(string)
  {
    let hash = 0;
    
    if(string.length == 0) return hash;
    
    for(let i = 0; i < string.length; i++)
    {
      let char = string.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    
    return hash;
  } 
  
  /**
   * Returns true if the given UUID is not already contained in the existing namespace values
   * @param {string} uuid - UUID to check
   * @return {boolean}
   **/
  function isNamespaceUUIDUnique(uuid)
  {
    for(let i=0; i < namespaces.length; i++)
    {
      if(namespaces[i]["uuid"] === uuid) return false;
    }
    
    return true;
  }
  
  /**
   * Returns the index for the XML namespace with the given ID, or -1 if it is not found
   * @param {string} uuid - UUID to get the index of
   * @return {number}
   **/
  function getNamespaceIndex(uuid)
  {
    for(let i=0; i < namespaces.length; i++)
    {
      if(namespaces[i]["uuid"] === uuid) return i;
    }
    
    return -1;
  }

  /**
   * Callback invoked when a file is selected via the file picker.
   * @param {string} fileSelectData Stringified JSON for the file selection result.
   * @param {function} callback Callback invoked to pass selected file id and name, if the file selection was valid.
   **/
  function tryParseFileSelect(fileSelectData, callback)
  {
    let json = JSON.parse(fileSelectData);

    if(json[SELECT_FILE_KEYS.Valid] !== true) return false;

    let fileJson = json[SELECT_FILE_KEYS.File];
    let fileId = fileJson.hasOwnProperty("id") ? fileJson["id"] : "";
    let fileName = fileJson.hasOwnProperty("name") ? fileJson["name"] : "";

    callback(fileId, fileName);

    return true;
  }
  
  /**
   * Open a file explorer to select a custom export folder.
   **/
  function openFolderPicker()
  {
    return google.script.run.withSuccessHandler(selectExportFolder).openFilePicker(MimeTypes.Folder, "Select Export Folder");
  }
  
  /**
   * Open a file explorer to select a JSON file to replace contents on.
   **/
  function openJsonFilePicker()
  {
    return google.script.run.withSuccessHandler(selectReplaceFileJson).openFilePicker(MimeTypes.JSON, "Select JSON File");
  }
  
  /**
   * Open a file explorer to select a XML file to replace contents on.
   **/
  function openXmlFilePicker()
  {
    return google.script.run.withSuccessHandler(selectReplaceFileXml).openFilePicker(MimeTypes.XML, "Select XML File");
  }

  /**
   * Callback invoked when the user selects a custom export location via the file picker.
   * @param {string} fileSelectData Stringified JSON containing data for a file's ID and name.
   **/
  function selectExportFolder(fileSelectData)
  {
    tryParseFileSelect(fileSelectData, (fileId, fileName) => {
      exportFolderId = fileId;
      exportFolderName = fileName;

      onGetExportFolderName(exportFolderName);
    });
  }

  /**
   * Callback invoked when the user selects a JSON file to replace via the file picker.
   * @param {string} fileSelectData Stringified JSON containing data for a file's ID and name.
   **/
  function selectReplaceFileJson(fileSelectData)
  {
    tryParseFileSelect(fileSelectData, (fileId, fileName) => {
      replaceFileJsonId = fileId;
      replaceFileJsonName = fileName;

      onGetReplaceFileJsonName(replaceFileJsonName);
    });
  }

  /**
   * Callback invoked when the user selects a XML file to replace via the file picker.
   * @param {string} fileSelectData Stringified JSON containing data for a file's ID and name.
   **/
  function selectReplaceFileXml(fileSelectData)
  {
    tryParseFileSelect(fileSelectData, (fileId, fileName) => {
      replaceFileXmlId = fileId;
      replaceFileXmlName = fileName;

      onGetReplaceFileXmlName(replaceFileXmlName);
    });
  }

  /**
   * Open the target export folder in a new tab.
   **/
  function openExportFolder()
  {
    google.script.run.withSuccessHandler(onOpenReplaceFileSuccess).getWebViewLinkFromId(exportFolderId);
  }

  /**
   * Open the file that will update its contents when exporting JSON.
   **/
  function openReplaceFileJson()
  {
    google.script.run.withSuccessHandler(onOpenReplaceFileSuccess).getWebViewLinkFromId(replaceFileJsonId);
  }

  /**
   * Open the file that will update its contents when exporting XML.
   **/
  function openReplaceFileXml()
  {
    google.script.run.withSuccessHandler(onOpenReplaceFileSuccess).getWebViewLinkFromId(replaceFileXmlId);
  }

  /**
   * Callback invoked to open a target file location.
   **/
  function onOpenReplaceFileSuccess(webViewLink)
  {
    window.open(webViewLink);
  }
  
  //General Options
  /**
   * Toggle the unwrapSingleRows boolean's value.
   **/
  function toggleUnwrapSingleRows()
  {
    unwrapSingleRows = !unwrapSingleRows;

    if(unwrapSingleRows && collapseSingleRows)
    {
      collapseSingleRows = false;

      document.getElementById("collapseSingleRowToggle").checked = false;
    }
  }
  
  /**
   * Toggle the collapseSingleRows boolean's value.
   **/
  function toggleCollapseSingleRows()
  {
    collapseSingleRows = !collapseSingleRows;

    if(unwrapSingleRows && collapseSingleRows)
    {
      unwrapSingleRows = false;

      document.getElementById("unwrapSingleRowToggle").checked = false;
    }
  }
  
  /**
   * Toggle the ignoreEmptyCells boolean's value.
   **/
  function toggleIgnoreEmptyCells()
  {
    ignoreEmptyCells = !ignoreEmptyCells;
  }
  
  //Advanced
  /**
   * Toggle the nestedElements boolean's value.
   **/
  function toggleNestedElements()
  {
    nestedElements = !nestedElements;
  }
  
  /**
   * Toggle the minifyData boolean's value.
   **/
  function toggleMinifyData()
  {
      minifyData = !minifyData;
  }
  
  /**
   * Toggle the includeFirstColumn boolean's value.
   **/
  function toggleIncludeFirstColumn()
  {
    includeFirstColumn = !includeFirstColumn;
  }
  
  /**
   * Get the ignoreColumnsPrefix value. This will return an empty string if ignoreColumnsWithPrefix is false
   * @return {string}
   **/
  function getIgnorePrefix()
  {
    if(ignoreColumnsWithPrefix === false) return "";
  
    return ignoreColumnsPrefix === "" ? IGNORE_COLUMN_DEFAULT : ignoreColumnsPrefix;
  }
  
  /**
   * Update the ignoreColumnsPrefix value to the current value set in its field
   **/
  function updateIgnorePrefix()
  {
    ignoreColumnsPrefix = document.getElementById("ignoreColumnsPrefixTextField").value;
  }
  
  /**
   * Toggle the ignoreColumnsWithPrefix boolean's value.
   **/
  function toggleIgnoreColumnsWithPrefix()
  {
    ignoreColumnsWithPrefix = !ignoreColumnsWithPrefix;
    
    tryGetElementById('ignoreColumnsPrefixTextField', (element) => element.disabled = !ignoreColumnsWithPrefix);
    /*if(document.getElementById('ignoreColumnsPrefixTextField') != null)
    {
      document.getElementById('ignoreColumnsPrefixTextField').disabled = !ignoreColumnsWithPrefix;
    }*/
  }
  
  /**
   * Get the unwrapSheetsPrefix value. This will return an empty string if unwrapSheetsWithPrefix is false
   * @return {string}
   **/
  function getUnwrapPrefix()
  {
    if(unwrapSheetsWithPrefix === false) return "";
  
    return unwrapSheetsPrefix === "" ? UNWRAP_SHEETS_DEFAULT : unwrapSheetsPrefix;
  }
  
  /**
   * Update the unwrapSheetsPrefix value to the current value set in its field
   **/
  function updateUnwrapPrefix()
  {
    unwrapSheetsPrefix = document.getElementById("unwrapSheetsPrefixTextField").value;
  }
  
  /**
   * Toggle the unwrapSheetsWithPrefix boolean's value.
   **/
  function toggleUnwrapSheetsWithPrefix()
  {
    unwrapSheetsWithPrefix = !unwrapSheetsWithPrefix;
    
    tryGetElementById('unwrapSheetsPrefixTextField', (element) => element.disabled = !unwrapSheetsWithPrefix);
    
    /*if(document.getElementById('unwrapSheetsPrefixTextField') != null)
    {
      document.getElementById('unwrapSheetsPrefixTextField').disabled = !unwrapSheetsWithPrefix;
    }*/
  }
  
  /**
   * Get the collapseSheetsPrefix value. This will return an empty string if collapseSheetsWithPrefix is false
   * @return {string}
   **/
  function getCollapsePrefix()
  {
    if(collapseSheetsWithPrefix === false) return "";
  
    return collapseSheetsPrefix === "" ? COLLAPSE_SHEETS_DEFAULT : collapseSheetsPrefix;
  }
  
  /**
   * Update the collapseSheetsPrefix value to the current value set in its field
   **/
  function updateCollapsePrefix()
  {
    collapseSheetsPrefix = document.getElementById("collapseSheetsPrefixTextField").value;
  }
  
  /**
   * Toggle the collapseSheetsWithPrefix boolean's value.
   **/
  function toggleCollapseSheetsWithPrefix()
  {
    collapseSheetsWithPrefix = !collapseSheetsWithPrefix;
    
    tryGetElementById('collapseSheetsPrefixTextField', (element) => element.disabled = !collapseSheetsWithPrefix);
    /*if(document.getElementById('collapseSheetsPrefixTextField') != null)
    {
      document.getElementById('collapseSheetsPrefixTextField').disabled = !collapseSheetsWithPrefix;
    }*/
  }
  
  //XML Options
  /**
   * Callback method that changes XML replace file target between default and custom.
   **/
  function changeReplaceFileTypeXml()
  {
    replaceFileXmlType = document.getElementById("replaceFileXml").value;

    refreshFileDataFields(replaceFileXmlId, replaceFileXmlType, REPLACE_FILE_OPTIONS.Disabled, "replaceFileXmlNameSection", "replaceFileXmlName", "openReplaceFileXmlButton", "Select file...", "openXmlFilePicker()", "openReplaceFileXml()", onGetReplaceFileXmlName);
  }

  /**
   * Toggle the exportChildElementXml boolean's value.
   **/
  function toggleElement()
  {
    exportChildElementXml = !exportChildElementXml;
  }
  
  /**
   * Toggle the exportBoolsAsInts boolean's value.
   **/
  function toggleExportBoolsAsInts()
  {
    exportBoolsAsInts = !exportBoolsAsInts;
  }
  
  /**
   * get the rootElementXml value. Returns a default value if rootElementXml is empty
   * @return {string}
   **/ 
  function getRootElement()
  {
    return rootElementXml === "" ? XML_ROOT_DEFAULT : rootElementXml;
  }
  
  //Advanced XML
  /**
   * Get the declarationVersionXml value. This will return an empty string if includeDeclarationXml is false
   * @return {string}
   **/
  function getDeclarationVersion()
  {
    if(includeDeclarationXml === false) return "";
    
    return declarationVersionXml;
  }
  
  /**
   * Get the declarationEncodingXml value. This will return an empty string if includeDeclarationXml is false or if declarationEncodingXml is set to "none"
   * @return {string}
   **/
  function getDeclarationEncoding()
  {
    if(includeDeclarationXml === false) return "";
    
    return declarationEncodingXml === "none" ? "" : declarationEncodingXml;
  }
  
  /**
   * Get the declarationStandaloneXml value. This will return an empty string if includeDeclarationXml is false or if declarationStandaloneXml is set to "none"
   * @return {string}
   **/
  function getDeclarationStandalone()
  {
    if(includeDeclarationXml === false) return "";
    
    return declarationStandaloneXml === "none" ? "" : declarationStandaloneXml;
  }
  
  /**
   * Get the forceAttributesPrefixXml value. This will return an empty string if forceAttributesXml is false or a default value if forceAttributesPrefixXml is empty
   * @return {string}
   **/
  function getAttributePrefix()
  {
    if(forceAttributesXml === false) return "";
  
    return forceAttributesPrefixXml === "" ? XML_ATT_DEFAULT : forceAttributesPrefixXml;
  }
  
  /**
   * Get the forceChildElementsPrefixXml value. This will return an empty string if forceChildElementsXml is false or a default value if forceChildElementsPrefixXml is empty
   * @return {string}
   **/
  function getChildElementPrefix()
  {
    if(forceChildElementsXml === false) return "";
  
    return forceChildElementsPrefixXml === "" ? XML_CE_DEFAULT : forceChildElementsPrefixXml;
  }
  
  /**
   * Get the forceInnerTextPrefixXml value. This will return an empty string if forceInnerTextXml is false or a default value if forceInnerTextPrefixXml is empty
   * @return {string}
   **/
  function getInnerTextPrefix()
  {
    if(forceInnerTextXml === false) return "";
    
    return forceInnerTextPrefixXml === "" ? XML_IT_DEFAULT : forceInnerTextPrefixXml;
  }
  
  /**
   * Update the rootElementXml value to the current value set in its field
   **/
  function updateRootElementXml()
  {
    rootElementXml = document.getElementById("xmlRootField").value;
  }
  
  /**
   * Update the forceAttributesPrefixXml value to the current value set in its field
   **/
  function updateAttributePrefixXml()
  {
    forceAttributesPrefixXml = document.getElementById("xmlForceAttributesTextField").value;
  }
  
  /**
   * Update the forceChildElementsPrefixXml value to the current value set in its field
   **/
  function updateChildElementPrefixXml()
  {
    forceChildElementsPrefixXml = document.getElementById("xmlForceChildElementsTextField").value;
  }
  
  /**
   * Update the forceInnerTextPrefixXml value to the current value set in its field
   **/
  function updateInnerTextPrefixXml()
  {
    forceInnerTextPrefixXml = document.getElementById("xmlForceInnerTextTextField").value;
  }
  
  /**
   * Callback method that changes replacement char used in XML elements with illegal characters
   **/
  function changeNameReplacementCharXml()
  {
    nameReplacementCharXml = document.getElementById("xmlNameReplaceCharDropdown").value;
  }
  
  /**
   * Toggle the includeDeclarationXml boolean's value.
   **/
  function toggleIncludeDeclarationXml()
  {
    includeDeclarationXml = !includeDeclarationXml;
    
    if(document.getElementById('xmlIncludeDeclarationToggle') != null)
    {
      document.getElementById('xmlDeclarationVersionDropdown').disabled = !includeDeclarationXml;
      document.getElementById('xmlDeclarationEncodingDropdown').disabled = !includeDeclarationXml;
      document.getElementById('xmlDeclarationStandaloneDropdown').disabled = !includeDeclarationXml;
    }
  }
  
  /**
   * Callback method that changes the declarationVersionXml value
   **/ 
  function changeDeclarationVersionXml()
  {
    declarationVersionXml = document.getElementById("xmlDeclarationVersionDropdown").value;
  }
  
  /**
   * Callback method that changes the declarationEncodingXml value
   **/ 
  function changeDeclarationEncodingXml()
  {
    declarationEncodingXml = document.getElementById("xmlDeclarationEncodingDropdown").value;
  }
  
  /**
   * Callback method that changes the declarationStandaloneXml value
   **/ 
  function changeDeclarationStandaloneXml()
  {
    declarationStandaloneXml = document.getElementById("xmlDeclarationStandaloneDropdown").value;
  }
  
  /**
   * Toggle the forceAttributesXml boolean's value.
   **/
  function toggleAttributePrefixXml()
  {
    forceAttributesXml = !forceAttributesXml;
    
    tryGetElementById('xmlForceAttributesTextField', (element) => element.disabled = !forceAttributesXml);
    /*if(document.getElementById('xmlForceAttributesTextField') != null)
    {
      document.getElementById('xmlForceAttributesTextField').disabled = !forceAttributesXml;
    }*/
  }
  
  /**
   * Toggle the forceChildElementsXml boolean's value.
   **/
  function toggleChildElementPrefixXml()
  {
    forceChildElementsXml = !forceChildElementsXml;

    tryGetElementById('xmlForceChildElementsTextField', (element) => element.disabled = !forceChildElementsXml);
    
    /*if(document.getElementById('xmlForceChildElementsTextField') != null)
    {
      document.getElementById('xmlForceChildElementsTextField').disabled = !forceChildElementsXml;
    }*/
  }
  
  /**
   * Toggle the forceInnerTextXml boolean's value.
   **/
  function toggleInnerTextPrefixXml()
  {
    forceInnerTextXml = !forceInnerTextXml;
    
    tryGetElementById('xmlForceInnerTextTextField', (element) => element.disabled = !forceInnerTextXml);
    /*if(document.getElementById('xmlForceInnerTextTextField') != null)
    {
      document.getElementById('xmlForceInnerTextTextField').disabled = !forceInnerTextXml;
    }*/
  }
  
  //XML Namespaces
  /**
   * Update the current root xmlns URI value to the current value set in its field
   **/
  function updateRootNamespaceXml()
  {
    rootNamespace = document.getElementById("xmlRootNamespaceField").value;
  }
  
  /**
   * Add a new namespace to the list of namespaces and create HTML for it in the sidebar
   **/
  function addNamespaceXml()
  {
    let newNamespace = { "prefix": "", "uri": "" };
    let uuid = stringToHash(getUUID());
    
    while(!isNamespaceUUIDUnique(uuid))
    {
      uuid = stringToHash(getUUID());
    }
    
    newNamespace["uuid"] = uuid;
    
    namespaces.push(newNamespace);
    
    let newNamespaceText = getNamespaceTextXml(namespaces.length - 1, false);
    let node = document.createElement("div");

    node.innerHTML = newNamespaceText;
    
    document.getElementById("xmlNamespaceParent").appendChild(node);
    
    let placeholder = document.getElementById("xmlNamespacePlaceholder");
    
    if(placeholder != null) placeholder.remove();
    
    refreshNamespaceAccordionListeners();
  }
  
  /**
   * Update the prefix for the namespace with the given UUID
   * @param {string} uuid - UUID for the target namespace
   **/
  function updateNamespacePrefix(uuid)
  {
    let index = getNamespaceIndex(uuid);
    let prefixElement = document.getElementById("namespacePrefix" + uuid);
    
    namespaces[index]["prefix"] = prefixElement.value;
    
    document.getElementById("namespaceAccordion" + uuid).innerHTML = "xmlns:" + namespaces[index]["prefix"];
  }
  
  /**
   * Update the URI for the namespace with the given UUID
   * @param {string} uuid - UUID for the target namespace
   **/
  function updateNamespaceUri(uuid)
  {
    let index = getNamespaceIndex(uuid);
    
    namespaces[index]["uri"] = document.getElementById("namespaceUri" + uuid).value;
  }
  
  /**
   * Delete the namespace with the given UUID and remove its HTML in the sidebar
   * @param {string} uuid - UUID for the target namespace
   **/
  function deleteNamespaceXml(uuid)
  {
    let index = getNamespaceIndex(uuid);
    
    //Delete the namespace's DOM object
    document.getElementById("namespace" + uuid).remove();
    
    namespaces.splice(index, 1);
    
    if(namespaces.length === 0)
    {
      let namespaceParent = document.getElementById("xmlNamespaceParent");
      let node = document.createElement("p");
      
      node.id = "xmlNamespacePlaceholder";
      node.classList.add("namespacePlaceholder");
      node.innerHTML = XML_NAMESPACE_PLACEHOLDER;
      namespaceParent.appendChild(node);
    }
  }
  
  /**
   * Get HTML text for the namespace at the given index. If hidden is true, the namespace accordion will be hidden
   * @param {number} index - Index for the target namespace
   * @param {boolean} hidden - If the namespace section should be expanded (false) or collapsed (true)
   * @return {string}
   **/
  function getNamespaceTextXml(index, hidden)
  {
    //TODO: Apply tinting to empty fields...
    let newNamespaceText = "<div class='xmlNamespace' id='namespace" + namespaces[index]["uuid"] + "'>";
    
    newNamespaceText += "<div class='accordion xmlHeader" + (hidden ? "" : " active") + "' id='namespaceAccordion" + namespaces[index]["uuid"] + "'>xmlns:" + namespaces[index]["prefix"] + "</div><div class='accordionPanel" + (hidden ? " hidden" : "") + "'><div class='paddedPanel'>";
    newNamespaceText += "<div class='option'>Prefix</div><div class='listButtonParent'><button class='listButton' onclick='deleteNamespaceXml(" + namespaces[index]["uuid"] + ")'>-</button></div><p><input id='namespacePrefix" + namespaces[index]["uuid"] + "' type='text' value='" + namespaces[index]["prefix"] + "' onchange='updateNamespacePrefix(" + namespaces[index]["uuid"] + ")'></p>";
    newNamespaceText += "<div class='option'>URI</div><p><input id='namespaceUri" + namespaces[index]["uuid"] + "' type='text' value='" + namespaces[index]["uri"] + "' onchange='updateNamespaceUri(" + namespaces[index]["uuid"] + ")'></p>";
    
    newNamespaceText += "</div></div></div>";
    
    return newNamespaceText;
  }
  
  /**
   * Refresh onclick event listeners for XML namespace accordions
   **/
  function refreshNamespaceAccordionListeners()
  {
    let parent = document.getElementById("xmlNamespaceParent");
    let accordions = parent.getElementsByClassName("accordion");
    
    for(let i=0; i < accordions.length; i++)
    {
      let index = i;
      
      accordions[index].onclick = function()
      {
        this.classList.toggle("active");
        
        let panel = this.nextElementSibling;
        
        panel.classList.toggle("hidden");
      };
    }
  }
  
  //JSON Options
  /**
   * Callback method that changes JSON replace file target between default and custom.
   **/
  function changeReplaceFileTypeJson()
  {
    replaceFileJsonType = document.getElementById("replaceFileJson").value;
    
    refreshFileDataFields(replaceFileJsonId, replaceFileJsonType, REPLACE_FILE_OPTIONS.Disabled, "replaceFileJsonNameSection", "replaceFileJsonName", "openReplaceFileJsonButton", "Select file...", "openJsonFilePicker()", "openReplaceFileJson()", onGetReplaceFileJsonName);
  }
  
  function refreshFileDataFields(fileId, fileOperationType, defaultOperationType, sectionElementId, inputElementId, openButtonId, inputPlaceholder, fileSelectionCallback, openFileCallback, getFileNameCallback)
  {
    const hasTargetFile = fileId != null && fileId !== "";
    let sectionText = "";

    if(fileOperationType !== defaultOperationType)
    {
      sectionText = "<input id='" + inputElementId + "' type='text' size='12' value='' placeholder='" + inputPlaceholder + "' disabled /> ";
      sectionText += "<button onclick='" + fileSelectionCallback + "'>Browse</button><button id='" + openButtonId + "' onclick='" + openFileCallback + "'";
      
      if(!hasTargetFile) sectionText += " disabled";

      sectionText += ">Open</button>";
    }
    
    document.getElementById(sectionElementId).innerHTML = sectionText;

    if(hasTargetFile) getFileName(fileId, getFileNameCallback);
  }
  
  /**
   * Toggle the forceStringJson boolean's value.
   **/
  function toggleForceStringJson()
  {
    forceStringJson = !forceStringJson;
  }
  
  /**
   * Toggle the exportCellArrayJson boolean's value.
   **/
  function toggleArrayJson()
  {
    exportCellArrayJson = !exportCellArrayJson;
  }
  
  /**
   * Toggle the exportSheetArrayJson boolean's value.
   **/
  function toggleSheetArrayJson()
  {
    exportSheetArrayJson = !exportSheetArrayJson;
  }
  
  /**
   * Toggle the exportValueArrayJson boolean's value.
   **/
  function toggleValueArrayJson()
  {
    exportValueArrayJson = !exportValueArrayJson;
  }

  //Advanced JSON Options

  /**
   * Toggle the exportContentsAsArrayJson boolean's value.
   **/
  function toggleContentArrayJson()
  {
    exportContentsAsArrayJson = !exportContentsAsArrayJson;
  }
  
  /**
   * Toggle the exportCellObjectJson boolean's value.
   **/
  function toggleCellObjectJson()
  {
    exportCellObjectJson = !exportCellObjectJson;
  }
  
  /**
   * Get the arraySeparatorCharJson value. This will return a default value if arraySeparatorCharJson is empty, a single quote ( ' ) or a double quote ( " )
   * @return {string}
   **/
  function getSeparatorCharJson()
  {
    return (arraySeparatorCharJson === "" || arraySeparatorCharJson === "'" || arraySeparatorCharJson === '"') ? JSON_SEPARATOR_DEFAULT : arraySeparatorCharJson;
  }
  
  /**
   * Get the forceArrayPrefixJson value. This will return an empty string if forceArrayJson is false or a default value if forceArrayPrefixJson is empty
   * @return {string}
   **/
  function getForceArrayPrefixJson()
  {
    if(forceArrayJson === false) return "";
  
    return forceArrayPrefixJson === "" ? JSON_JA_DEFAULT : forceArrayPrefixJson;
  }
  
  /**
   * Callback method that changes the exported value for empty cells
   **/
  function changeEmptyValueFormatJson()
  {
    emptyValueFormatJson = document.getElementById("jsonEmptyValueFormatDropdown").value;
  }
  
  /**
   * Callback method that changes the exported value for cells containing a string value of "null"
   **/
  function changeNullValueFormatJson()
  {
    nullValueFormatJson = document.getElementById("jsonNullValueFormatDropdown").value;
  }
  
  /**
   * Update the arraySeparatorCharJson value to the current value set in its field
   **/
  function updateSeparatorCharJson()
  {
    arraySeparatorCharJson = document.getElementById("jsonArraySeparatorCharTextField").value;
  }
  
  /**
   * Toggle the forceArrayJson boolean's value.
   **/
  function toggleArrayPrefixJson()
  {
    forceArrayJson = !forceArrayJson;
    
    tryGetElementById('jsonForceArrayTextField', (element) => element.disabled = !forceArrayJson);
    /*if(document.getElementById('jsonForceArrayTextField') != null)
    {
      document.getElementById('jsonForceArrayTextField').disabled = !forceArrayJson;
    }*/
  }
  
  /**
   * Update the forceArrayPrefixJson value to the current value set in its field
   **/
  function updateArrayPrefixJson()
  {
    forceArrayPrefixJson = document.getElementById("jsonForceArrayTextField").value;
  }
  
  //Nested Elements options
  /**
   * Toggle the forceArrayNest boolean's value.
   **/
  function toggleArrayPrefixNest()
  {
    forceArrayNest = !forceArrayNest;
    
    tryGetElementById('nestForceArrayTextField', (element) => element.disabled = !forceArrayNest);
    /*if(document.getElementById('nestForceArrayTextField') != null)
    {
      document.getElementById('nestForceArrayTextField').disabled = !forceArrayNest;
    }*/
  }
  
  /**
   * Update the forceArrayPrefixNest value to the current value set in its field
   **/
  function updateArrayPrefixNest()
  {
    forceArrayPrefixNest = document.getElementById("nestForceArrayTextField").value;
  }
  
  /**
   * Get the forceArrayPrefixNest value. This will return an empty string if forceArrayNest is false or a default value if forceArrayPrefixNest is empty
   * @return {string}
   **/
  function getForceArrayPrefixNest()
  {
    if(forceArrayNest === false) return "";
  
    return forceArrayPrefixNest === "" ? NEST_NA_DEFAULT : forceArrayPrefixNest;
  }
  
  /**
   * Rebuild the sidebar. This should be called after loading export parameters
   **/
  function refreshSideBar()
  {
    removeGeneralListeners();
    
    let generalText = "<div class='accordion generalHeader active'><h1>Format</h1></div><div class='accordionPanel'>";
    //Export Settings
    //Format
    generalText += "<div class='block form-group sectionWrapper'>";
    generalText += "<p><div class='option'><label for='formatSelect'><b>Export Format</b></label><div class='tooltip note padded'>Data format to export to.</div></div><br><select id='formatSelect'><option value='" + ExportFormats.JSON + "'";
    if(exportFormatType === ExportFormats.JSON) generalText += " selected";
    generalText += ">JSON</option><option value='" + ExportFormats.XML + "'";
    if(exportFormatType !== ExportFormats.JSON) generalText += " selected";
    generalText += ">XML</option></select></p>";
    //Export Folder
    generalText += "<p><div class='option'><label for='folderSelect'><b>Export Folder</b></label><div class='tooltip note padded'>Drive folder to export files to. If replacing a file, this is ignored.</div></div><br><select id='folderSelect'><option value='" + EXPORT_FOLDER_LOCATIONS.MyDrive + "'";
    if(exportFolderType === EXPORT_FOLDER_LOCATIONS.MyDrive) generalText += " selected";
    else if(exportFolderType === "default") generalText += " selected"; //Fallback for old data...
    generalText += ">My Drive</option><option value='" + EXPORT_FOLDER_LOCATIONS.Custom + "'";
    if(exportFolderType !== EXPORT_FOLDER_LOCATIONS.MyDrive && exportFolderType !== 'default') generalText += " selected";
    generalText += ">Custom</option></select></p>";
    //Target export folder
    generalText += "<div id='exportFolderNameSection'>";

    if(exportFolderType !== EXPORT_FOLDER_LOCATIONS.MyDrive)
    {
      generalText += "<input id='exportFolderName' type='text' size='12' value='' placeholder='Select folder...' disabled /> ";
      generalText += "<button onclick='openFolderPicker()'>Browse</button><button id='openExportFolderButton' onclick='openExportFolder()'";
      
      if(exportFolderId == null || exportFolderId === "") generalText += " disabled";

      generalText += ">Open</button>";
    }

    generalText += "</div>";

    //Sheets
    generalText += "<p><div class='option'><label for='sheetSelect'><b>Export Sheet(s)</b></label><div class='tooltip note padded'>Sheets to export data from.</div></div><br><select id='sheetSelect'><option value='" + ExportSheetTypes.All + "'";
    if(exportSheetsType === ExportSheetTypes.All) generalText += " selected";
    generalText += ">All sheets</option><option value='" + ExportSheetTypes.CurrentOnly + "'";
    if(exportSheetsType === ExportSheetTypes.CurrentOnly) generalText += " selected";
    generalText += ">Current sheet only</option><option value='" + ExportSheetTypes.Custom + "'";
    if(exportSheetsType === ExportSheetTypes.Custom) generalText += " selected";
    generalText += ">Custom</option></select></p>";
    //Custom Sheets
    generalText += "<div id='customSheetSelect'></div></div>"; //Sheet selection is filled automatically at end of refresh process.
    generalText += "</div>";
    
    //General Options
    generalText += "<div class='accordion generalHeader active'><h1>General</h1></div><div class='accordionPanel'>";
    //Minify Data
    generalText += "<div class='sectionWrapper'><input id='minifyDataToggle' type='checkbox' value='minifyData'";
    if(minifyData) generalText += " checked";
    generalText += "><div class='option'><label for='minifyDataToggle'>Minify data</label><div class='tooltip note'>Remove human readability formatting from the exported data to produce a smaller file.</div></div></div>";
    //Export bools as ints
    generalText += "<div class='sectionWrapper'><input id='exportBoolsAsIntsToggle' type='checkbox' value='false'";
    if(exportBoolsAsInts) generalText += " checked";
    generalText += "/><div class='option'><label for='exportBoolsAsIntsToggle'>Export bools as ints</label><div class='tooltip note'>Export [true] and [false] boolean values as [1] and [0] respectively..</div></div></div>";
    //Ignore empty cells
    generalText += "<div class='sectionWrapper'><input id='ignoreEmptyCellsToggle' type='checkbox' value='false'";
    if(ignoreEmptyCells) generalText += " checked";
    generalText += "/><div class='option'><label for='ignoreEmptyCellsToggle'>Ignore empty cells</label><div class='tooltip note'>Don't export cells that are empty.</div></div></div>";
    //Include first column in export
    generalText += "<div class='sectionWrapper'><input id='firstColumnToggle' type='checkbox' value='false'";
    if(includeFirstColumn) generalText += " checked";
    generalText += "/><div class='option'><label for='firstColumnToggle'>Include first column</label><div class='tooltip note'>Export the first column as a distinct element in addition to using it as the name of each row element.</div></div></div>";
    //Section end
    generalText += "</div>";
    
    //Advanced General Options
    generalText += "<div class='accordion generalHeader active'><h1>Advanced</h1></div><div class='accordionPanel'>";
    //Nested Elements
    generalText += "<div class='sectionWrapper'><input id='nestedElementsToggle' type='checkbox' value='false'";
    if(nestedElements) generalText += " checked";
    if(exportFormatType !== ExportFormats.JSON) generalText += " disabled";
    generalText += "/><div class='option'><label for='nestedElementsToggle'>Nested Elements</label><div class='tooltip note'>Export nested elements by using specific formatting in keys.";
    if(exportFormatType !== ExportFormats.JSON) generalText += " XML support in development!";
    generalText += "</div></div></div>";
    //Unwrap Single Rows
    generalText += "<div class='sectionWrapper'><input id='unwrapSingleRowToggle' type='checkbox' value='false'";
    if(unwrapSingleRows) generalText += " checked";
    generalText += "/><div class='option'><label for='unwrapSingleRowToggle'>Unwrap single row sheets</label><div class='tooltip note'>Don't wrap a sheet's contents with a JSON object / XML element if it contains only one row. (not counting keys)</div></div></div>";
    //Collapse Single Rows
    generalText += "<div class='sectionWrapper'><input id='collapseSingleRowToggle' type='checkbox' value='false'";
    if(collapseSingleRows) generalText += " checked";
    generalText += "/><div class='option'><label for='collapseSingleRowToggle'>Collapse single row sheets</label><div class='tooltip note'>Collapse a sheet's contents into a JSON object / XML element if it contains only one row. (not counting keys)</div></div></div>";
    //Ignore columns prefix
    generalText += "<div class='sectionWrapper'><input id='ignoreColumnsToggle' type='checkbox' value='false'";
    if(ignoreColumnsWithPrefix) generalText += " checked";
    generalText += "/><div class='option'><label for='ignoreColumnsToggle'>Ignore prefix</label><div class='tooltip note'>Don't export columns with keys using the specified prefix, or rows whose first value starts with the specified prefix.</div></div>";
    generalText += "<div class='subOption'><p id='ignoreColumnsText'><input id='ignoreColumnsPrefixTextField' type='text' value='";
    generalText += ignoreColumnsPrefix === "" ? IGNORE_COLUMN_DEFAULT : ignoreColumnsPrefix;
    generalText += "' placeholder='" + IGNORE_COLUMN_DEFAULT + "'";
    if(ignoreColumnsWithPrefix === false) generalText += " disabled";
    generalText += "/></p><p class='note'></p></div></div>";
    //Unwrap sheets prefix
    generalText += "<div class='sectionWrapper'><input id='unwrapSheetsToggle' type='checkbox' value='false'";
    if(unwrapSheetsWithPrefix) generalText += " checked";
    generalText += "/><div class='option'><label for='unwrapSheetsToggle'>Unwrap sheet prefix</label><div class='tooltip note'>Unwrap sheets that use the given prefix.</div></div>";
    generalText += "<div class='subOption'><p id='unwrapSheetsText'><input id='unwrapSheetsPrefixTextField' type='text' value='";
    generalText += unwrapSheetsPrefix === "" ? UNWRAP_SHEETS_DEFAULT : unwrapSheetsPrefix;
    generalText += "' placeholder='" + UNWRAP_SHEETS_DEFAULT +"'";
    if(unwrapSheetsWithPrefix === false) generalText += " disabled";
    generalText += "/></p><p class='note'></p></div></div>";
    //Collapse sheets prefix
    generalText += "<div class='sectionWrapper'><input id='collapseSheetsToggle' type='checkbox' value='false'";
    if(collapseSheetsWithPrefix) generalText += " checked";
    generalText += "/><div class='option'><label for='collapseSheetsToggle'>Collapse sheet prefix</label><div class='tooltip note'>Collapse sheets with only one row that use the given prefix.</div></div>";
    generalText += "<div class='subOption'><p id='collapseSheetsText'><input id='collapseSheetsPrefixTextField' type='text' value='";
    generalText += collapseSheetsPrefix === "" ? COLLAPSE_SHEETS_DEFAULT : collapseSheetsPrefix;
    generalText += "' placeholder='" + COLLAPSE_SHEETS_DEFAULT + "'";
    if(collapseSheetsWithPrefix === false) generalText += " disabled";
    generalText += "/></p><p class='note'></p></div></div>";
    //Section end
    generalText += "</div>";
    
    document.getElementById("generalOptions").innerHTML = generalText;
    
    //Listeners
    addGeneralListeners();
    
    if(exportSheetsType === ExportSheetTypes.Custom) getSheetNamesAndIds(initializeSheetToggles);
    
    exportFormatType = document.getElementById("formatSelect").value;
    
    if(exportFormatType !== ExportFormats.JSON) //Populate XML options
    {
      removeJsonListeners();
      
      document.getElementById("jsonOptions").innerHTML = "";
      document.getElementById("advancedOptions").innerHTML = "";
      document.getElementById("xmlNamespaces").innerHTML = "";
      
      removeXmlListeners();
      
      let xmlText = "<div class='accordion xmlHeader active'><h1>XML</h1></div><div class='accordionPanel'>";
      //Replace File
      xmlText += "<p><div class='sectionWrapper'><div class='option'><label for='replaceFileXml'>Replace File</label><div class='tooltip note padded'>If set, will replace the contents of the target file instead of exporting a new file.</div></div><br><select id='replaceFileXml' onchange='changeReplaceFileTypeXml()'><option value='" + REPLACE_FILE_OPTIONS.Disabled + "'";
      if(replaceFileXmlType === REPLACE_FILE_OPTIONS.Disabled) xmlText += " selected";
      xmlText += ">Disabled</option><option value='" + REPLACE_FILE_OPTIONS.Enabled + "'";
      if(replaceFileXmlType !== REPLACE_FILE_OPTIONS.Disabled) xmlText += " selected";
      xmlText += ">Enabled</option></select></p>";
      //Target file
      xmlText += "<div id='replaceFileXmlNameSection'>";

      if(replaceFileXmlType !== REPLACE_FILE_OPTIONS.Disabled)
      {
        xmlText += "<input id='replaceFileXmlName' type='text' size='12' value='' placeholder='Select file...' disabled /> ";
        xmlText += "<button onclick='openXmlFilePicker()'>Browse</button><button id='openReplaceFileXmlButton' onclick='openReplaceFileXml()'";
        
        if(replaceFileXmlId == null || replaceFileXmlId === "") xmlText += " disabled";

        xmlText += ">Open</button>";
      }

      xmlText += "</div></div>";

      //Export child elements
      xmlText += "<div class='sectionWrapper'><input id='elementToggle' type='checkbox' value='false'";
      if(exportChildElementXml) xmlText += " checked";
      xmlText += "/><div class='option'><label for='elementToggle'>Export columns as child elements</label><div class='tooltip note'>Export a sheet's columns as child elements instead of attributes for each row.</div></div></div>";
      //Root element value
      xmlText += "<div class='sectionWrapper'><div class='option'>Root element<div class='tooltip note padded'>Root element for the exported XML document.</div></div><input id='xmlRootField' type='text' value=";
      xmlText += "'" + rootElementXml + "'";
      xmlText += " placeholder='" + XML_ROOT_DEFAULT + "'/></div>";
      xmlText += "</div>";
      
      //Advanced Options
      let advancedXmlText = "<div class='accordion xmlHeader active'><h1>Advanced XML</h1></div><div class='accordionPanel'>";
      //Invalid element name char replacement
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='xmlNameReplaceCharDropdown'>Name replacement char</label><div class='tooltip note padded'>What character to use when replacing illegal characters in XML element names.</div></div><br><select id='xmlNameReplaceCharDropdown' onchange='changeNameReplacementCharXml()'><option value='_'";
      if(nameReplacementCharXml === "_") advancedXmlText += " selected";
      advancedXmlText += ">Underscore ( _ )</option><option value='-'";
      if(nameReplacementCharXml === "-") advancedXmlText += " selected";
      advancedXmlText += ">Dash ( - )</option><option value='.'";
      if(nameReplacementCharXml === ".") advancedXmlText += " selected";
      advancedXmlText += ">Dot ( . )</option></select></div>";
      //Declaration
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlIncludeDeclarationToggle' type='checkbox' value='false'";
      if(includeDeclarationXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'><label for='xmlIncludeDeclarationToggle'>Include XML declaration</label><div class='tooltip note'>Include a customized XML declaration at the top of exported XML files using the parameters set below.</div></div></div>";
      //Declaration Version
      advancedXmlText += "<div id='xmlDeclarationSection'>";
      advancedXmlText += "<div class='subOption'><div class='sectionWrapper'><div class='option'><label for='xmlDeclarationVersionDropdown'>XML version</label><div class='tooltip note padded'>Version of the XML standard that the XML document conforms to.</div></div><br><select id='xmlDeclarationVersionDropdown' onchange='changeDeclarationVersionXml()'";
      if(includeDeclarationXml === false) advancedXmlText += " disabled";
      advancedXmlText += "><option value='1.0'";
      if(declarationVersionXml === "1.0") advancedXmlText += " selected";
      advancedXmlText += ">1.0</option><option value='1.1'";
      if(declarationVersionXml === "1.1") advancedXmlText += " selected";
      advancedXmlText += ">1.1</option></select></p></div>";
      //Declaration Encoding
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='xmlDeclarationEncodingDropdown'>XML encoding</label><div class='tooltip note padded'>Identifies which encoding is used to represent the characters in the document.</div></div><br><select id='xmlDeclarationEncodingDropdown' onchange='changeDeclarationEncodingXml()'";
      if(includeDeclarationXml === false) advancedXmlText += " disabled";
      advancedXmlText += ">";

      for(let i=0; i < XML_DECLARATION_ENCODINGS.length; i++)
      {
        if(XML_DECLARATION_ENCODINGS[i] === "None")
        {
          //Special none check for backwards compatibility...
          advancedXmlText += "<option value='" + XML_DECLARATION_ENCODINGS[i] + "'";
          if(declarationEncodingXml === XML_DECLARATION_ENCODINGS[i] || declarationEncodingXml === "none") advancedXmlText += " selected";
          advancedXmlText += ">" + XML_DECLARATION_ENCODINGS[i] + "</option>";
        }
        else
        {
          advancedXmlText += "<option value='" + XML_DECLARATION_ENCODINGS[i] + "'";
          if(declarationEncodingXml === XML_DECLARATION_ENCODINGS[i]) advancedXmlText += " selected";
          advancedXmlText += ">" + XML_DECLARATION_ENCODINGS[i] + "</option>";
        }
      }

      advancedXmlText += "</select></div>";

      //Declaration Standalone
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='xmlDeclarationStandaloneDropdown'>Standalone</label><div class='tooltip note padded'>Indicates whether a document relies on information from an external source, such as external document type definition (DTD).</div></div><br><select id='xmlDeclarationStandaloneDropdown' onchange='changeDeclarationStandaloneXml()'";
      if(includeDeclarationXml === false) advancedXmlText += " disabled";
      advancedXmlText += "><option value='none'";
      if(declarationStandaloneXml === "none") advancedXmlText += " selected";
      advancedXmlText += ">None</option><option value='yes'";
      if(declarationStandaloneXml === "yes") advancedXmlText += " selected";
      advancedXmlText += ">Yes</option><option value='no'";
      if(declarationStandaloneXml === "no") advancedXmlText += " selected";
      advancedXmlText += ">No</option></select></div></div>";
      advancedXmlText += "</div>";
      //Force attribute column export
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlForceAttributeToggle' type='checkbox' value='false'";
      if(forceAttributesXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'><label for='xmlForceAttributeToggle'>Attributes prefix</label><div class='tooltip note'>Force columns with keys using the specified prefix to export as attributes.</div></div>";
      advancedXmlText += "<div class='subOption'><p id='xmlForceAttributeText'><input id='xmlForceAttributesTextField' type='text' value=";
      advancedXmlText += "'" + forceAttributesPrefixXml + "'";
      advancedXmlText += " placeholder='" + XML_ATT_DEFAULT + "'";
      if(forceAttributesXml === false) advancedXmlText += " disabled";
      advancedXmlText += "/></p></div></div>";
      //Force child element column export
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlForceChildElementToggle' type='checkbox' value='false'";
      if(forceChildElementsXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'><label for='xmlForceChildElementToggle'>Child elements prefix</label><div class='tooltip note'>Force columns with keys using the specified prefix to export as child elements.</div></div>";
      advancedXmlText += "<div class='subOption'><p id='xmlForceChildElementsText'><input id='xmlForceChildElementsTextField' type='text' value=";
      advancedXmlText += "'" + forceChildElementsPrefixXml + "'";
      advancedXmlText += " placeholder='" + XML_CE_DEFAULT + "'";
      if(forceChildElementsXml === false) advancedXmlText += " disabled";
      advancedXmlText += "/></p></div></div>";
      //Force inner text column export
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlForceInnerTextToggle' type='checkbox' value='false'";
      if(forceInnerTextXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'><label for='xmlForceInnerTextToggle'>Inner text prefix</label><div class='tooltip note'>Force columns with keys using the specified prefix to export as inner text of the row element.</div></div>";
      advancedXmlText += "<div class='subOption'><p id='xmlForceInnerTextText'><input id='xmlForceInnerTextTextField' type='text' value=";
      advancedXmlText += "'" + forceInnerTextPrefixXml + "'";
      advancedXmlText += " placeholder='" + XML_IT_DEFAULT + "'";
      if(forceInnerTextXml === false) advancedXmlText += " disabled";
      advancedXmlText += "/></p></div></div></div>";
      
      //XML Namespaces
      let xmlNamespaceText = "<div class='accordion xmlHeader active'><h1>XML Namespaces</h1></div><div class='accordionPanel'>";
      //Root namespace value
      xmlNamespaceText += "<div class='sectionWrapper'><div class='option'>Root namespace URI<div class='tooltip note padded'>URI for the root <span class='tooltipHighlight'>xmlns</span> namespace used when creating elements in the exported XML document.</div></div><input id='xmlRootNamespaceField' type='text' value=";
      xmlNamespaceText += "'" + rootNamespace + "'/></div>";
      //Namespaces
      xmlNamespaceText += "<div class='sectionWrapper'><div class='option'>Namespaces<div class='tooltip note padded'>Namespaces used when creating elements in the exported XML document.</div></div>";
      xmlNamespaceText += "<div class='listButtonParent'><button class='listButton bottomButton' id='newNamespaceButton'>+</button></div>";
      xmlNamespaceText += "<div class='namespaceGap'></div>"; //Padding to prevent the list button pushing the first namespace down and creating whitespace.
      xmlNamespaceText += "<div class='xmlNamespaces' id='xmlNamespaceParent'>";
      
      let namespaceText = "";
      
      for(let i=0; i < namespaces.length; i++)
      {
        let text = getNamespaceTextXml(i, true);
        namespaceText += text;
      }
      
      if(namespaces.length === 0) namespaceText += "<p class='namespacePlaceholder' id='xmlNamespacePlaceholder'>" + XML_NAMESPACE_PLACEHOLDER + "</p>";
      
      xmlNamespaceText += namespaceText;
      
      xmlNamespaceText += "</div>";
      //Close section div
      xmlNamespaceText += "</div>";
      //Close accordion div
      xmlNamespaceText += "</div>";
      
      document.getElementById("xmlOptions").innerHTML = xmlText;
      document.getElementById("advancedOptions").innerHTML = advancedXmlText;
      document.getElementById("xmlNamespaces").innerHTML = xmlNamespaceText;
      
      addXmlListeners();
      refreshNamespaceAccordionListeners();
    }
    else //Populate JSON options
    {
      removeXmlListeners();
      
      document.getElementById("xmlOptions").innerHTML = "";
      document.getElementById("advancedOptions").innerHTML = "";
      document.getElementById("xmlNamespaces").innerHTML = "";
    
      removeJsonListeners();
      
      //JSON Options
      let jsonText = "<div class='accordion jsonHeader active'><h1>JSON</h1></div><div class='accordionPanel'>";
      //Replace File
      jsonText += "<p><div class='sectionWrapper'><div class='option'><label for='replaceFileJson'>Replace File</label><div class='tooltip note padded'>If set, will replace the contents of the target file instead of exporting a new file.</div></div><br><select id='replaceFileJson' onchange='changeReplaceFileTypeJson()'><option value='" + REPLACE_FILE_OPTIONS.Disabled + "'";
      if(replaceFileJsonType === REPLACE_FILE_OPTIONS.Disabled) jsonText += " selected";
      jsonText += ">Disabled</option><option value='" + REPLACE_FILE_OPTIONS.Enabled + "'";
      if(replaceFileJsonType !== REPLACE_FILE_OPTIONS.Disabled) jsonText += " selected";
      jsonText += ">Enabled</option></select></p>";
      //Target file
      jsonText += "<div id='replaceFileJsonNameSection'>";

      if(replaceFileJsonType !== REPLACE_FILE_OPTIONS.Disabled)
      {
        jsonText += "<input id='replaceFileJsonName' type='text' size='12' value='' placeholder='Select file...' disabled /> ";
        jsonText += "<button onclick='openJsonFilePicker()'>Browse</button><button id='openReplaceFileJsonButton' onclick='openReplaceFileJson()'";
        
        if(replaceFileJsonId == null || replaceFileJsonId === "") jsonText += " disabled";

        jsonText += ">Open</button>";
      }

      jsonText += "</div></div>";
      //Force string JSON
      jsonText += "<div class='sectionWrapper'><input id='forceStringToggle' type='checkbox' value='Force'";
      if(forceStringJson) jsonText += " checked";
      jsonText += "><div class='option'><label for='forceStringToggle'>Force string values</label><div class='tooltip note'>Force exported values to be strings.</div></div></div>";
      //Commas to array JSON
      jsonText += "<div class='sectionWrapper'><input id='arrayToggle' type='checkbox' value='Array'";
      if(exportCellArrayJson) jsonText += " checked";
      jsonText += "><div class='option'><label for='arrayToggle'>Export cell arrays</label><div class='tooltip note'>Export a cell's contents as a JSON array if it contains commas (or whatever char is specified in advanced JSON settings). Wrap content in quotation marks to prevent mid-content breaking.</div></div></div>";
      //Sheet to JSON object array
      jsonText += "<div class='sectionWrapper'><input id='sheetArrayToggle' type='checkbox' value='SheetArray'";
      if(exportSheetArrayJson) jsonText += " checked";
      jsonText += "><div class='option'><label for='sheetArrayToggle'>Export sheet arrays</label><div class='tooltip note'>Export a sheet's contents as an array of JSON objects.</div></div></div>";
      //Sheet to JSON value array
      jsonText += "<div class='sectionWrapper'><input id='valueArrayToggle' type='checkbox' value='ValueArray'";
      if(exportValueArrayJson) jsonText += " checked";
      jsonText += "><div class='option'><label for='valueArrayToggle'>Export value arrays</label><div class='tooltip note'>Export a sheet's contents as an array of JSON values if it has only one column.</div></div></div></div>";
      
      //Advanced Options
      let advancedJsonText = "<div class='accordion jsonHeader active'><h1>Advanced JSON</h1></div><div class='accordionPanel'>";
      //Content to array JSON
      advancedJsonText += "<div class='sectionWrapper'><input id='contentsArrayToggle' type='checkbox' value='ContentArray'";
      if(exportContentsAsArrayJson) advancedJsonText += " checked";
      advancedJsonText += "><div class='option'><label for='contentsArrayToggle'>Export contents as array</label><div class='tooltip note'>Export total contents as a raw JSON array. (<span class='tooltipHighlight'>WARNING:</span> This means the exported data will not be formatted as a stand-alone JSON object.)</div></div></div>";
      //Braces to object JSON
      advancedJsonText += "<div class='sectionWrapper'><input id='cellObjectToggle' type='checkbox' value='CellObject'";
      if(exportCellObjectJson) advancedJsonText += " checked";
      advancedJsonText += "><div class='option'><label for='cellObjectToggle'>Export cell objects</label><div class='tooltip note'>Export a cell's contents as a JSON object if it is wrapped in braces, or a JSON array if wrapped in brackets. (<span class='tooltipHighlight'>WARNING:</span> This content will export an empty object/array if not properly formatted.)</div></div></div>";
      //Empty Value Type
      advancedJsonText += "<div class='sectionWrapper'><div class='option'><label for='jsonEmptyValueFormatDropdown'>Empty value format</label><div class='tooltip note padded'>What value to export for empty cells.</div></div><br><select id='jsonEmptyValueFormatDropdown' onchange='changeEmptyValueFormatJson()'><option value='null'";
      if(emptyValueFormatJson === "null") advancedJsonText += " selected";
      advancedJsonText += ">Null ( null )</option><option value='string'";
      if(emptyValueFormatJson === "string") advancedJsonText += " selected";
      advancedJsonText += ">Empty String ( &quot;&quot; )</option></select></div>";
      //Null Value Type
      advancedJsonText += "<div class='sectionWrapper'><div class='option'><label for='jsonNullValueFormatDropdown'>Null value format</label><div class='tooltip note padded'>What value to export for cells with a string value of &quot;null&quot;.</div></div><br><select id='jsonNullValueFormatDropdown' onchange='changeNullValueFormatJson()'><option value='null'";
      if(nullValueFormatJson === "null") advancedJsonText += " selected";
      advancedJsonText += ">Null ( null )</option><option value='string'";
      if(nullValueFormatJson === "string") advancedJsonText += " selected";
      advancedJsonText += ">String ( &quot;null&quot; )</option></select></div>";
      //Separator char value
      advancedJsonText += "<div class='sectionWrapper'><div class='option'>Array separator character<div class='tooltip note padded'>Character used to separate elements when exporting cell arrays.</div></div><input id='jsonArraySeparatorCharTextField' type='text' maxlength='1' value=";
      advancedJsonText += "'" + arraySeparatorCharJson + "'";
      advancedJsonText += " placeholder='" + JSON_SEPARATOR_DEFAULT + "'";
      advancedJsonText += "/></div>";
      //Force JSON array export
      advancedJsonText += "<div class='sectionWrapper'><input id='jsonForceArrayToggle' type='checkbox' value='false'";
      if(forceArrayJson === true) advancedJsonText += " checked";
      advancedJsonText += "/><div class='option'><label for='jsonForceArrayToggle'>Array prefix</label><div class='tooltip note'>Force sheets or cells in columns with keys using the specified prefix to export as JSON arrays.</div></div>";
      advancedJsonText += "<div class='subOption'><p id='jsonForceArrayText'><input id='jsonForceArrayTextField' type='text' value=";
      advancedJsonText += "'" + forceArrayPrefixJson + "'";
      advancedJsonText += " placeholder='" + JSON_JA_DEFAULT + "'";
      if(forceArrayJson === false) advancedJsonText += " disabled";
      advancedJsonText += "/></p></div></div>";
      //Force nested array export
      advancedJsonText += "<div class='sectionWrapper'><input id='nestForceArrayToggle' type='checkbox' value='false'";
      if(forceArrayNest === true) advancedJsonText += " checked";
      advancedJsonText += "/><div class='option'><label for='nestForceArrayToggle'>Nested Array prefix</label><div class='tooltip note'>Force sheets with names using the specified prefix to export as Nested Element arrays.</div></div>";
      advancedJsonText += "<div class='subOption'><p id='nestForceArrayText'><input id='nestForceArrayTextField' type='text' value=";
      advancedJsonText += "'" + forceArrayPrefixNest + "'";
      advancedJsonText += " placeholder='" + NEST_NA_DEFAULT + "'";
      if(forceArrayNest === false) advancedJsonText += " disabled";
      advancedJsonText += "/></p></div></div>";
      advancedJsonText += "</div>";
      
      document.getElementById("jsonOptions").innerHTML = jsonText;
      document.getElementById("advancedOptions").innerHTML = advancedJsonText;
      
      addJsonListeners();
    }
    
    //Refresh target file names if valid...
    if(exportFolderType !== EXPORT_FOLDER_LOCATIONS.MyDrive && exportFolderId !== "") getFileName(exportFolderId, onGetExportFolderName); //Populate the name of the target export folder
    if(replaceFileXmlType !== REPLACE_FILE_OPTIONS.Disabled && replaceFileXmlId !== "") getFileName(replaceFileXmlId, onGetReplaceFileXmlName); //Populate the name of the target replace XML file
    if(replaceFileJsonType !== REPLACE_FILE_OPTIONS.Disabled && replaceFileJsonId !== "") getFileName(replaceFileJsonId, onGetReplaceFileJsonName); //Populate the name of the target replace JSON file
    
    addAccordionListeners();
  }
  
  /**
   * Callback method that changes export format between XML and JSON
   **/
  function changeExportFormat()
  {
    exportFormatType = document.getElementById("formatSelect").value;
    
    refreshSideBar();
  }
  
  /**
   * Callback method that changes export folder target between default and custom.
   **/
  function changeExportFolderFormat()
  {
    exportFolderType = document.getElementById("folderSelect").value;
    
    refreshFileDataFields(exportFolderId, exportFolderType, EXPORT_FOLDER_LOCATIONS.MyDrive, "exportFolderNameSection", "exportFolderName", "openExportFolderButton", "Select folder...", "openFolderPicker()", "openExportFolder()", onGetExportFolderName);
  }
  
  /**
   * Callback method that updates the method for selecting sheets for export
   **/
  function changeExportSheets()
  {
    exportSheetsType = document.getElementById("sheetSelect").value;
    
    if(exportSheetsType !== ExportSheetTypes.Custom)
    {
      clearSheetToggles();
    }
    else
    {
      getSheetNamesAndIds(initializeSheetToggles);
    }
  }

  /**
   * Get an array of target sheet IDs for export.
   * @param {Array<object>} sheetData Data for sheets to export or ignore
   **/
  function getTargetSheetsArray(sheetData)
  {
    let sheetArray = [];

    for(key in sheetData)
    {
      if(sheetData[key] === true)
      {
        sheetArray.push(parseInt(key));
      }
    }

    return sheetArray;
  }
  
  /**
   * Formats a sheet name so special characters don't break event listeners
   * @param {string} sheetName - Name to format
   * @return {string}
   **/
  function formatSheetName(sheetName)
  {
    return sheetName.replace(/[^a-zA-Z0-9\-\_]/gm, "_");
  }
  
  /**
   * Initialize data for custom sheet export.
   * @param {Array<object>} sheetData Name and ID values for sheets currently contained in the active spreadsheet.
   **/
  function initializeSheetToggles(sheetData)
  {
    for(let i=0; i < sheetData.length; i++)
    {
      sheetData[i]["toggleName"] = formatSheetName(sheetData[i]["name"]);
      sheetData[i]["toggleId"] = sheetData[i]["id"].toString();
    }

    currentSheets = sheetData;
    
    generateAutoSheetToggles(sheetData);
  }
  
  /**
   * Generates toggle elements determining which sheets should be exported
   * @param {Array<string>} sheetsData - Names and IDs for sheets to generate toggles for
   **/
  function generateAutoSheetToggles(sheetsData)
  {
    let cachedToggles = targetSheets; //Cache existing settings to persist current target sheets

    clearSheetToggles();
    
    //Check if all sheets are being exported
    let allActive = true;
    
    for(let i=0; i < sheetsData.length; i++)
    {
      let toggleValue = cachedToggles[sheetsData[i]["toggleId"]];
      
      if(toggleValue == null || toggleValue === false || toggleValue === 'false')
      {
        allActive = false;
        break;
      }
    }

    //Generate toggles...
    let text = "<div id='allToggleContainer'><input id='allSheetsToggle' type='checkbox' value='" + allActive + "' onChange='toggleAllSheets()' ";
    
    if(allActive === true) text += "checked ";
    
    text += "/><label for='allSheetsToggle'> All</label></div><hr><div class='scrollWrapper'>";

    for(let i=0; i < sheetsData.length; i++)
    {
      text += "<p>";
      
      if(cachedToggles[sheetsData[i]["toggleId"]] != null)
      {
        let toggleValue = cachedToggles[sheetsData[i]["toggleId"]];
        text += "<input id='" + sheetsData[i]["toggleId"] + "Toggle' type='checkbox' value='" + (toggleValue === true) + "'";
        if(toggleValue === true) text += " checked";
        text += "/><label for='" + sheetsData[i]["toggleId"] + "Toggle'> " + sheetsData[i]["name"] + "</label>";
        
        targetSheets[sheetsData[i]["toggleId"]] = cachedToggles[sheetsData[i]["toggleId"]] === true;
      }
      else
      {
        text += "<input id='" + sheetsData[i]["toggleId"] + "Toggle' type='checkbox' value='false'/><label for='" + sheetsData[i]["toggleId"] + "Toggle'> " + sheetsData[i]["name"] + "</label>";
        targetSheets[sheetsData[i]["toggleId"]] = false;
      }
      
      text += "</p>";
    }
    
    text += "</div><hr>";
    
    document.getElementById("customSheetSelect").innerHTML = text;

    if(getSheetToggleSummaryStatus() === 2)
    {
      console.log("Indeterminate!");
      document.getElementById('allSheetsToggle').indeterminate = true;
    }
    
    createSheetToggleListeners();
  }
  
  /**
   * Generates toggle elements determining which sheets should be exported and sets their export value to be the given default value
   * @param {Array<string>} sheetsData - Names and IDs for sheets to generate toggles for
   * @param {boolean} defaultValue - Default value for toggles
   **/
  function generateSheetToggles(sheetsData, defaultValue)
  {
    clearSheetToggles();
    
    let text = "<div id='allToggleContainer'><input id='allSheetsToggle' type='checkbox' value='" + defaultValue + "' onChange='toggleAllSheets()' ";
    
    if(defaultValue === true) text += "checked ";
    
    text += "/><label for='allSheetsToggle'> All</label></div><hr><div class='scrollWrapper'>";

    for(let i=0; i < sheetsData.length; i++)
    {
      text += "<p>";
      
      if(defaultValue === true)
      {
        text += "<input id='" + sheetsData[i]["toggleId"] + "Toggle' type='checkbox' value='true' checked /><label for='" + sheetsData[i]["toggleId"] + "Toggle'> " + sheetsData[i]["name"] + "</label>";
        targetSheets[sheetsData[i]["toggleId"]] = true;
      }
      else
      {
        text += "<input id='" + sheetsData[i]["toggleId"] + "Toggle' type='checkbox' value='false' /><label for='" + sheetsData[i]["toggleId"] + "Toggle'> " + sheetsData[i]["name"] + "</label>";
        targetSheets[sheetsData[i]["toggleId"]] = false;
      }
      
      text += "</p>";
    }
    
    text += "</div><hr>";
    
    document.getElementById("customSheetSelect").innerHTML = text;

    if(getSheetToggleSummaryStatus() === 2)
    {
      console.log("Indeterminate2!");
      document.getElementById('allSheetsToggle').indeterminate = true;
    }
    
    createSheetToggleListeners();
  }
  
  /**
   * Toggles value for exporting all sheets
   **/
  function toggleAllSheets()
  {
    let allToggle = document.getElementById('allSheetsToggle');
    let value = allToggle.value;
    
    allToggle.indeterminate = false;
    
    if(value === 'false') generateSheetToggles(currentSheets, true);
    else generateSheetToggles(currentSheets, false);
  }
  
  /**
   * Sets all sheets to be exported
   **/
  function selectAllSheets()
  {
    generateSheetToggles(currentSheets, true);
  }
  
  /**
   * Sets no sheets to be exported
   **/
  function deselectAllSheets()
  {
    generateSheetToggles(currentSheets, false);
  }

  /**
   * Checks the status of all custom sheet export toggles and returns a value indicating the summary state. 0 for all false, 1 for all true, and 2 for indeterminate.
   * @return {number}
   **/
  function getSheetToggleSummaryStatus()
  {
    let status = 0;
    let count = 0;

    for(let i=0; i < currentSheets.length; i++)
    {
      if(targetSheets[currentSheets[i]["toggleId"]] === true) count++;
    }

    if(count === currentSheets.length) status = 1;
    else if(count > 0) status = 2;

    return status;
  }
  
  /**
   * Updates the toggle for all sheets so that it is only checked when all sheets are set for export
   **/
  function updateAllSheetsToggle()
  {
    let value = getSheetToggleSummaryStatus();
    let html = "";
    
    switch(value)
    {
      case 0:
      case 2:
        html = "<input id='allSheetsToggle' type='checkbox' value='false' onChange='toggleAllSheets()' /><label for='allSheetsToggle'> All</label>";
        break;
      case 1:
        html = "<input id='allSheetsToggle' type='checkbox' value='true' onChange='toggleAllSheets()' checked /><label for='allSheetsToggle'> All</label>";
        break;
    }

    document.getElementById('allToggleContainer').innerHTML = html;

    if(value === 2)
    {
      document.getElementById('allSheetsToggle').indeterminate = true;
    }
  }
  
  /**
   * Toggles a sheet for export
   * @param {string} sheetName - Name for the target sheet
   **/
  function toggleSheet(sheetData)
  {
    let value = document.getElementById(sheetData["toggleId"] + 'Toggle').value;
    
    if(value === 'false') value = 'true';
    else value = 'false';
    
    targetSheets[sheetData["toggleId"]] = value === 'true';
    
    document.getElementById(sheetData["toggleId"] + 'Toggle').value = value;
    
    updateAllSheetsToggle();
  }
  
  /**
   * Creates event listeners for sheet export toggles
   **/
  function createSheetToggleListeners()
  {
    for(let i=0; i < currentSheets.length; i++)
    {
      (function()
      {
        let targetSheet = currentSheets[i];
        document.getElementById(targetSheet["toggleId"] + 'Toggle').addEventListener("change", function() { toggleSheet(targetSheet); });
      }())
    }
  }
  
  /**
   * Removes event listeners for sheet export toggles
   **/
  function clearSheetToggles()
  {
    targetSheets = { };
    
    for(let i=0; i < currentSheets.length; i++)
    {
      (function()
      {
        if(document.getElementById(currentSheets[i]["toggleId"] + 'Toggle') != null)
        {
          let targetSheet = currentSheets[i];
          document.getElementById(targetSheet["toggleId"] + 'Toggle').removeEventListener("change", function() { toggleSheet(targetSheet); });
        }
      }())
    }
    
    document.getElementById("customSheetSelect").innerHTML = "";
  }
  
  /**
   * Adds event listeners for general options.
   **/
  function addGeneralListeners()
  {
    //Format Settings
    document.getElementById('formatSelect').addEventListener("change", changeExportFormat);
    document.getElementById('folderSelect').addEventListener("change", changeExportFolderFormat);
    document.getElementById('sheetSelect').addEventListener("change", changeExportSheets);
    //General Options
    document.getElementById('exportBoolsAsIntsToggle').addEventListener("change", toggleExportBoolsAsInts);
    document.getElementById('unwrapSingleRowToggle').addEventListener("change",toggleUnwrapSingleRows);
    document.getElementById('collapseSingleRowToggle').addEventListener("change",toggleCollapseSingleRows);
    document.getElementById('ignoreEmptyCellsToggle').addEventListener("change",toggleIgnoreEmptyCells);
    //Advanced
    document.getElementById('nestedElementsToggle').addEventListener("change",toggleNestedElements);
    document.getElementById('minifyDataToggle').addEventListener("change", toggleMinifyData);
    document.getElementById('firstColumnToggle').addEventListener("change", toggleIncludeFirstColumn);
    document.getElementById('ignoreColumnsToggle').addEventListener("change",toggleIgnoreColumnsWithPrefix);
    document.getElementById('ignoreColumnsPrefixTextField').addEventListener("change", updateIgnorePrefix);
    document.getElementById('unwrapSheetsToggle').addEventListener("change",toggleUnwrapSheetsWithPrefix);
    document.getElementById('unwrapSheetsPrefixTextField').addEventListener("change", updateUnwrapPrefix);
    document.getElementById('collapseSheetsToggle').addEventListener("change",toggleCollapseSheetsWithPrefix);
    document.getElementById('collapseSheetsPrefixTextField').addEventListener("change", updateCollapsePrefix);
  }
  
  /**
   * Set up section accordion click interactions.
   **/
  function addAccordionListeners()
  {
    let accordions = document.getElementsByClassName("accordion");
    
    for(let i=0; i < accordions.length; i++)
    {
      // Check if the accorion is an XML namespace accordion and skip if it is. These have their own method for assigning event listeners.
      if(accordions[i].id.startsWith("namespace")) continue;
      
      accordions[i].addEventListener("click", function()
      {
        this.classList.toggle("active");
        
        let panel = this.nextElementSibling;
        
        panel.classList.toggle("hidden");
      });
    }
  }

  /**
   * Try to get a document element with the given ID.
   * @param {string} elementId ID for the target document element.
   * @param {function} callback Callback invoked to pass the target element if it is found. 
   **/
  function tryGetElementById(elementId, callback)
  {
    let element = document.getElementById(elementId);

    if(element == null) return false;

    callback(element);

    return true;
  }
  
  /**
   * Adds event listeners for XML options.
   **/
  function addXmlListeners()
  {
    //XML Options
    document.getElementById('elementToggle').addEventListener("change", toggleElement);
    //Advanced Options
    document.getElementById('xmlRootField').addEventListener("change", updateRootElementXml);
    document.getElementById('xmlNameReplaceCharDropdown').addEventListener("change", changeNameReplacementCharXml);
    document.getElementById('xmlIncludeDeclarationToggle').addEventListener("change", toggleIncludeDeclarationXml);
    document.getElementById('xmlDeclarationVersionDropdown').addEventListener("change", changeDeclarationVersionXml);
    document.getElementById('xmlDeclarationEncodingDropdown').addEventListener("change", changeDeclarationEncodingXml);
    document.getElementById('xmlDeclarationStandaloneDropdown').addEventListener("change", changeDeclarationStandaloneXml);
    document.getElementById('xmlForceAttributeToggle').addEventListener("change", toggleAttributePrefixXml);
    document.getElementById('xmlForceAttributesTextField').addEventListener("change", updateAttributePrefixXml);
    document.getElementById('xmlForceChildElementToggle').addEventListener("change", toggleChildElementPrefixXml);
    document.getElementById('xmlForceChildElementsTextField').addEventListener("change", updateChildElementPrefixXml);
    document.getElementById('xmlForceInnerTextToggle').addEventListener("change", toggleInnerTextPrefixXml);
    document.getElementById('xmlForceInnerTextTextField').addEventListener("change", updateInnerTextPrefixXml);
    //XML Namespaces
    document.getElementById('xmlRootNamespaceField').addEventListener("change", updateRootNamespaceXml);
    document.getElementById('newNamespaceButton').addEventListener("click", addNamespaceXml);
  }
  
  /**
   * Adds event listeners for JSON options.
   **/
  function addJsonListeners()
  {
    //JSON Options
    document.getElementById('forceStringToggle').addEventListener("change", toggleForceStringJson);
    document.getElementById('arrayToggle').addEventListener("change", toggleArrayJson);
    document.getElementById('sheetArrayToggle').addEventListener("change", toggleSheetArrayJson);
    document.getElementById('valueArrayToggle').addEventListener("change", toggleValueArrayJson);
    //Advanced Options
    document.getElementById('contentsArrayToggle').addEventListener("change", toggleContentArrayJson);
    document.getElementById('cellObjectToggle').addEventListener("change", toggleCellObjectJson);
    document.getElementById('jsonEmptyValueFormatDropdown').addEventListener("change", changeEmptyValueFormatJson);
    document.getElementById('jsonNullValueFormatDropdown').addEventListener("change", changeNullValueFormatJson);
    document.getElementById('jsonArraySeparatorCharTextField').addEventListener("change", updateSeparatorCharJson);
    document.getElementById('jsonForceArrayToggle').addEventListener("change", toggleArrayPrefixJson);
    document.getElementById('jsonForceArrayTextField').addEventListener("change", updateArrayPrefixJson);
    document.getElementById('nestForceArrayToggle').addEventListener("change", toggleArrayPrefixNest);
    document.getElementById('nestForceArrayTextField').addEventListener("change", updateArrayPrefixNest);
  }
  
  /**
   * Removes event listeners for general options.
   **/
  function removeGeneralListeners()
  {
    //Format
    tryGetElementById('formatSelect', (element) => element.removeEventListener("change", changeExportFormat));
    tryGetElementById('folderSelect', (element) => element.removeEventListener("change", changeExportFolderFormat));
    tryGetElementById('sheetSelect', (element) => element.removeEventListener("change", changeExportSheets));
    //General
    tryGetElementById('minifyDataToggle', (element) => element.removeEventListener("change", toggleMinifyData));
    tryGetElementById('exportBoolsAsIntsToggle', (element) => element.removeEventListener("change", toggleExportBoolsAsInts));
    tryGetElementById('ignoreEmptyCellsToggle', (element) => element.removeEventListener("change", toggleIgnoreEmptyCells));
    tryGetElementById('firstColumnToggle', (element) => element.removeEventListener("change", toggleIncludeFirstColumn));
    
    //Advanced
    tryGetElementById('nestedElementsToggle', (element) => element.removeEventListener("change", toggleNestedElements));
    tryGetElementById('unwrapSingleRowToggle', (element) => element.removeEventListener("change", toggleUnwrapSingleRows));
    tryGetElementById('collapseSingleRowToggle', (element) => element.removeEventListener("change", toggleCollapseSingleRows));
    tryGetElementById('ignoreColumnsToggle', (element) => element.removeEventListener("change", toggleIgnoreColumnsWithPrefix));
    tryGetElementById('ignoreColumnsPrefixTextField', (element) => element.removeEventListener("change", updateIgnorePrefix));
    tryGetElementById('unwrapSheetsToggle', (element) => element.removeEventListener("change", toggleUnwrapSheetsWithPrefix));
    tryGetElementById('unwrapSheetsPrefixTextField', (element) => element.removeEventListener("change", updateUnwrapPrefix));
    tryGetElementById('collapseSheetsToggle', (element) => element.removeEventListener("change", toggleCollapseSheetsWithPrefix));
    tryGetElementById('collapseSheetsPrefixTextField', (element) => element.removeEventListener("change", updateCollapsePrefix));
  }
  
  /**
   * Removes event listeners for XML option toggles
   **/
  function removeXmlListeners()
  {
    //Basic
    tryGetElementById('elementToggle', (element) => element.removeEventListener("change", toggleElement));
    tryGetElementById('xmlRootField', (element) => element.removeEventListener("change", updateRootElementXml));
    
    //Advanced
    tryGetElementById('xmlNameReplaceCharDropdown', (element) => element.removeEventListener("change", changeNameReplacementCharXml));
    
    tryGetElementById('xmlIncludeDeclarationToggle', (element) => element.removeEventListener("change", toggleIncludeDeclarationXml));
    tryGetElementById('xmlDeclarationVersionDropdown', (element) => element.removeEventListener("change", changeDeclarationVersionXml));
    tryGetElementById('xmlDeclarationEncodingDropdown', (element) => element.removeEventListener("change", changeDeclarationEncodingXml));
    tryGetElementById('xmlDeclarationStandaloneDropdown', (element) => element.removeEventListener("change", changeDeclarationStandaloneXml));
    
    tryGetElementById('xmlForceAttributeToggle', (element) => element.removeEventListener("change", toggleAttributePrefixXml));
    tryGetElementById('xmlForceAttributesTextField', (element) => element.removeEventListener("change", updateAttributePrefixXml));
    tryGetElementById('xmlForceChildElementToggle', (element) => element.removeEventListener("change", toggleChildElementPrefixXml));
    tryGetElementById('xmlForceChildElementsTextField', (element) => element.removeEventListener("change", updateChildElementPrefixXml));
    tryGetElementById('xmlForceInnerTextToggle', (element) => element.removeEventListener("change", toggleInnerTextPrefixXml));
    tryGetElementById('xmlForceInnerTextTextField', (element) => element.removeEventListener("change", updateInnerTextPrefixXml));
    
    //Namespaces
    tryGetElementById('xmlRootNamespaceField', (element) => element.removeEventListener("change", updateRootNamespaceXml));
    tryGetElementById('newNamespaceButton', (element) => element.removeEventListener("click", addNamespaceXml));
  }
  
  /**
   * Removes event listeners for JSON option toggles
   **/
  function removeJsonListeners()
  {
    //Basic
    tryGetElementById('replaceFileJson', (element) => element.addEventListener("change", changeReplaceFileTypeJson));
    tryGetElementById('forceStringToggle', (element) => element.removeEventListener("change", toggleForceStringJson));
    tryGetElementById('arrayToggle', (element) => element.removeEventListener("change", toggleArrayJson));
    tryGetElementById('sheetArrayToggle', (element) => element.removeEventListener("change", toggleSheetArrayJson));
    tryGetElementById('valueArrayToggle', (element) => element.removeEventListener("change", toggleValueArrayJson));
    
    //Advanced
    tryGetElementById('contentsArrayToggle', (element) => element.removeEventListener("change", toggleContentArrayJson));
    tryGetElementById('cellObjectToggle', (element) => element.removeEventListener("change", toggleCellObjectJson));
    tryGetElementById('jsonEmptyValueFormatDropdown', (element) => element.removeEventListener("change", changeEmptyValueFormatJson));
    tryGetElementById('jsonNullValueFormatDropdown', (element) => element.removeEventListener("change", changeNullValueFormatJson));
    tryGetElementById('jsonArraySeparatorCharTextField', (element) => element.removeEventListener("change", updateSeparatorCharJson));
    tryGetElementById('jsonForceArrayToggle', (element) => element.removeEventListener("change", toggleArrayPrefixJson));
    tryGetElementById('jsonForceArrayTextField', (element) => element.removeEventListener("change", updateArrayPrefixJson));
    tryGetElementById('nestForceArrayToggle', (element) => element.removeEventListener("change", toggleArrayPrefixNest));
    tryGetElementById('nestForceArrayTextField', (element) => element.removeEventListener("change", updateArrayPrefixNest));
  }
  
  /**
   * Set selected sheets to be visualized with the current options
   **/
  function visualizeFile()
  {
    visualizeData = true;
  
    if(exportFormatType === ExportFormats.XML) exportXml();
    else exportJson();
    
    setProperties();
  }
  
  /**
   * Set selected sheets to be exported with the current options
   **/
  function exportFile()
  {
    visualizeData = false;
  
    if(exportFormatType === ExportFormats.XML) exportXml();
    else exportJson();
    
    setProperties();
  }
  
  /**
   * Export XML.
   **/
  function exportXml()
  {
    if(exportSheetsType === ExportSheetTypes.CurrentOnly)
    {
      getActiveSheetNameAndId(exportXmlSingle);
    }
    else if(exportSheetsType === ExportSheetTypes.Custom)
    {
      google.script.run.withFailureHandler(onCatastrophicError).exportXml(generateXmlSettings(false, targetSheets));
    }
    else
    {
      google.script.run.withFailureHandler(onCatastrophicError).exportXml(generateXmlSettings(false, null));
    }
  }
  
  /**
   * Export only the given sheet to XML.
   **/
  function exportXmlSingle(sheet)
  {
    let newSheets = {};
    newSheets[sheet["id"].toString()] = true;
    
    google.script.run.withFailureHandler(onCatastrophicError).exportXml(generateXmlSettings(true, newSheets));
  }
  
  /**
   * Export JSON.
   **/
  function exportJson()
  {
    if(exportSheetsType === ExportSheetTypes.CurrentOnly)
    {
      getActiveSheetNameAndId(exportJsonSingle);
    }
    else if(exportSheetsType === ExportSheetTypes.Custom)
    {
      google.script.run.withFailureHandler(onCatastrophicError).exportJson(generateJsonSettings(false, targetSheets));
    }
    else
    {
      google.script.run.withFailureHandler(onCatastrophicError).exportJson(generateJsonSettings(false, null));
    }
  }
  
  /**
   * Export only the given sheet to JSON.
   **/
  function exportJsonSingle(sheet)
  {
    let newSheets = {};
    newSheets[sheet["id"].toString()] = true;
    
    google.script.run.withFailureHandler(onCatastrophicError).exportJson(generateJsonSettings(true, newSheets));
  }


  function onCatastrophicError(error)
  {
    alert(`There was a catastrophic error! This is probably because multiple accounts are signed in. See the troubleshooting section of documentation for more details. (Add-ons/Export Sheet Data/About/Documentation)\n\nError:\n${error.stack}`);
  }
  
  getProperties(updateProperties, onGetPropertiesFailure);
</script>